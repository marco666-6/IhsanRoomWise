// Controllers\AdminController.cs

using Microsoft.AspNetCore.Mvc;
using Microsoft.Data.SqlClient;
using ClosedXML.Excel;
using IhsanRoomWise.Functions;
using IhsanRoomWise.Models;
using System.Data;

namespace RoomWise.Controllers
{
    public class AdminController : Controller
    {
        private readonly string _connectionString;

        public AdminController()
        {
            _connectionString = new DbAccessFunction().GetConnectionString();
        }

        // ============================================
        // KF-11: Bookings Management
        // ============================================
        [HttpGet]
        public IActionResult BookingsView()
        {
            if (!CheckAdminAuth())
                return RedirectToAction("LoginView", "Auth");

            try
            {
                List<dynamic> bookings = new List<dynamic>();
                using (SqlConnection conn = new SqlConnection(_connectionString))
                {
                    conn.Open();
                    string query = @"SELECT b.*, r.room_code, r.room_name, u.user_full_name, u.user_employee_id
                                   FROM bookings b
                                   LEFT JOIN rooms r ON b.booking_room_id = r.room_id
                                   LEFT JOIN users u ON b.booking_user_id = u.user_id
                                   ORDER BY b.booking_date DESC, b.booking_start_time DESC";

                    using (SqlCommand cmd = new SqlCommand(query, conn))
                    {
                        using (SqlDataReader reader = cmd.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                bookings.Add(new
                                {
                                    booking_id = Convert.ToInt32(reader["booking_id"]),
                                    booking_code = reader["booking_code"].ToString(),
                                    booking_title = reader["booking_title"].ToString(),
                                    booking_description = reader["booking_description"]?.ToString(),
                                    booking_date = Convert.ToDateTime(reader["booking_date"]),
                                    booking_start_time = TimeSpan.Parse(reader["booking_start_time"].ToString()!),
                                    booking_end_time = TimeSpan.Parse(reader["booking_end_time"].ToString()!),
                                    booking_status = reader["booking_status"].ToString(),
                                    room_code = reader["room_code"]?.ToString(),
                                    room_name = reader["room_name"]?.ToString(),
                                    user_full_name = reader["user_full_name"]?.ToString(),
                                    user_employee_id = reader["user_employee_id"]?.ToString()
                                });
                            }
                        }
                    }
                }

                return View(bookings);
            }
            catch (Exception ex)
            {
                TempData["Error"] = "Error loading bookings: " + ex.Message;
                return View(new List<dynamic>());
            }
        }

        [HttpPost]
        public IActionResult ApproveBooking(int bookingId)
        {
            if (!CheckAdminAuth())
                return Json(new { success = false, message = "Unauthorized" });

            try
            {
                using (SqlConnection conn = new SqlConnection(_connectionString))
                {
                    conn.Open();
                    string query = "UPDATE bookings SET booking_status = 'Confirmed', booking_updated_at = GETDATE() WHERE booking_id = @BookingId";

                    using (SqlCommand cmd = new SqlCommand(query, conn))
                    {
                        cmd.Parameters.AddWithValue("@BookingId", bookingId);
                        cmd.ExecuteNonQuery();

                        LogActivity("Approve Booking", $"Approved booking ID: {bookingId}");

                        return Json(new { success = true, message = "Booking approved successfully" });
                    }
                }
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = "Error: " + ex.Message });
            }
        }

        [HttpPost]
        public IActionResult CancelBooking(int bookingId, string reason)
        {
            if (!CheckAdminAuth())
                return Json(new { success = false, message = "Unauthorized" });

            try
            {
                var adminId = HttpContext.Session.GetString("UserId");

                using (SqlConnection conn = new SqlConnection(_connectionString))
                {
                    conn.Open();
                    string query = @"UPDATE bookings 
                                   SET booking_status = 'Cancelled', 
                                       booking_cancel_reason = @Reason,
                                       booking_cancelled_by = @CancelledBy,
                                       booking_updated_at = GETDATE() 
                                   WHERE booking_id = @BookingId";

                    using (SqlCommand cmd = new SqlCommand(query, conn))
                    {
                        cmd.Parameters.AddWithValue("@Reason", reason);
                        cmd.Parameters.AddWithValue("@CancelledBy", adminId);
                        cmd.Parameters.AddWithValue("@BookingId", bookingId);
                        cmd.ExecuteNonQuery();

                        LogActivity("Cancel Booking", $"Cancelled booking ID: {bookingId}");

                        return Json(new { success = true, message = "Booking cancelled successfully" });
                    }
                }
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = "Error: " + ex.Message });
            }
        }

        // ============================================
        // KF-14: Export Data to Spreadsheet
        // ============================================
        [HttpGet]
        public IActionResult ExportBookings()
        {
            if (!CheckAdminAuth())
                return Forbid();

            try
            {
                using (var workbook = new XLWorkbook())
                {
                    var worksheet = workbook.Worksheets.Add("Bookings");

                    // Headers
                    worksheet.Cell(1, 1).Value = "Booking Code";
                    worksheet.Cell(1, 2).Value = "Title";
                    worksheet.Cell(1, 3).Value = "Room";
                    worksheet.Cell(1, 4).Value = "User";
                    worksheet.Cell(1, 5).Value = "Date";
                    worksheet.Cell(1, 6).Value = "Start Time";
                    worksheet.Cell(1, 7).Value = "End Time";
                    worksheet.Cell(1, 8).Value = "Status";

                    // Style headers
                    var headerRange = worksheet.Range(1, 1, 1, 8);
                    headerRange.Style.Font.Bold = true;
                    headerRange.Style.Fill.BackgroundColor = XLColor.LightGreen;

                    // Data
                    using (SqlConnection conn = new SqlConnection(_connectionString))
                    {
                        conn.Open();
                        string query = @"SELECT b.*, r.room_code, r.room_name, u.user_full_name
                                       FROM bookings b
                                       LEFT JOIN rooms r ON b.booking_room_id = r.room_id
                                       LEFT JOIN users u ON b.booking_user_id = u.user_id
                                       ORDER BY b.booking_date DESC";

                        using (SqlCommand cmd = new SqlCommand(query, conn))
                        {
                            using (SqlDataReader reader = cmd.ExecuteReader())
                            {
                                int row = 2;
                                while (reader.Read())
                                {
                                    worksheet.Cell(row, 1).Value = reader["booking_code"].ToString();
                                    worksheet.Cell(row, 2).Value = reader["booking_title"].ToString();
                                    worksheet.Cell(row, 3).Value = $"{reader["room_code"]} - {reader["room_name"]}";
                                    worksheet.Cell(row, 4).Value = reader["user_full_name"]?.ToString();
                                    worksheet.Cell(row, 5).Value = Convert.ToDateTime(reader["booking_date"]).ToString("yyyy-MM-dd");
                                    worksheet.Cell(row, 6).Value = reader["booking_start_time"].ToString();
                                    worksheet.Cell(row, 7).Value = reader["booking_end_time"].ToString();
                                    worksheet.Cell(row, 8).Value = reader["booking_status"].ToString();
                                    row++;
                                }
                            }
                        }
                    }

                    worksheet.Columns().AdjustToContents();

                    using (var stream = new MemoryStream())
                    {
                        workbook.SaveAs(stream);
                        stream.Position = 0;

                        LogActivity("Export Data", "Exported bookings data to Excel");

                        return File(stream.ToArray(), "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", $"Bookings_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx");
                    }
                }
            }
            catch (Exception ex)
            {
                TempData["Error"] = "Error exporting data: " + ex.Message;
                return RedirectToAction("BookingsView");
            }
        }

        // ============================================
        // HELPER METHODS
        // ============================================

        private void LogActivity(string action, string description)
        {
            try
            {
                var userId = HttpContext.Session.GetString("UserId");
                if (string.IsNullOrEmpty(userId)) return;

                using (SqlConnection conn = new SqlConnection(_connectionString))
                {
                    conn.Open();
                    
                    // Create table if not exists
                    string createTable = @"IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'activity_logs')
                                         BEGIN
                                             CREATE TABLE activity_logs (
                                                 log_id INT IDENTITY(1,1) PRIMARY KEY,
                                                 log_user_id INT NOT NULL,
                                                 log_action NVARCHAR(100) NOT NULL,
                                                 log_description NVARCHAR(500),
                                                 log_created_at DATETIME2 DEFAULT GETDATE(),
                                                 FOREIGN KEY (log_user_id) REFERENCES users(user_id)
                                             )
                                         END";
                    
                    using (SqlCommand createCmd = new SqlCommand(createTable, conn))
                    {
                        createCmd.ExecuteNonQuery();
                    }

                    string query = @"INSERT INTO activity_logs (log_user_id, log_action, log_description, log_created_at)
                                   VALUES (@UserId, @Action, @Description, GETDATE())";

                    using (SqlCommand cmd = new SqlCommand(query, conn))
                    {
                        cmd.Parameters.AddWithValue("@UserId", userId);
                        cmd.Parameters.AddWithValue("@Action", action);
                        cmd.Parameters.AddWithValue("@Description", description);
                        cmd.ExecuteNonQuery();
                    }
                }
            }
            catch
            {
                // Silent fail
            }
        }
    }
}