// Controllers\EmployeeController.cs

using Microsoft.AspNetCore.Mvc;
using Microsoft.Data.SqlClient;
using IhsanRoomWise.Functions;
using IhsanRoomWise.Models;
using System.Data;

namespace RoomWise.Controllers
{
    public class EmployeeController : Controller
    {
        private readonly string _connectionString;

        public EmployeeController()
        {
            _connectionString = new DbAccessFunction().GetConnectionString();
        }

        // ============================================
        // AUTHORIZATION CHECK
        // ============================================
        private bool CheckEmployeeAuth()
        {
            var role = HttpContext.Session.GetString("UserRole");
            return role == "Employee";
        }

        // ============================================
        // KF-15, KF-16, KF-22: Find Room View (Search and Filter)
        // ============================================
        [HttpGet]
        public IActionResult FindRoomView()
        {
            if (!CheckEmployeeAuth())
                return RedirectToAction("LoginView", "Auth");

            try
            {
                // Get all locations for filter
                ViewBag.Locations = GetActiveLocations();

                // Get all available rooms
                List<dynamic> rooms = new List<dynamic>();
                using (SqlConnection conn = new SqlConnection(_connectionString))
                {
                    conn.Open();
                    string query = @"SELECT r.*, l.location_code, l.location_plant_name, l.location_block, l.location_floor
                                   FROM rooms r
                                   LEFT JOIN locations l ON r.room_location_id = l.location_id
                                   WHERE r.room_is_active = 1
                                   ORDER BY r.room_name";

                    using (SqlCommand cmd = new SqlCommand(query, conn))
                    {
                        using (SqlDataReader reader = cmd.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                rooms.Add(new
                                {
                                    room_id = Convert.ToInt32(reader["room_id"]),
                                    room_code = reader["room_code"].ToString(),
                                    room_name = reader["room_name"].ToString(),
                                    room_capacity = Convert.ToInt32(reader["room_capacity"]),
                                    room_facilities = reader["room_facilities"]?.ToString(),
                                    room_status = reader["room_status"].ToString(),
                                    location_code = reader["location_code"]?.ToString(),
                                    location_plant_name = reader["location_plant_name"]?.ToString(),
                                    location_block = reader["location_block"] != DBNull.Value ? Convert.ToInt32(reader["location_block"]) : 0,
                                    location_floor = reader["location_floor"] != DBNull.Value ? Convert.ToInt32(reader["location_floor"]) : 0,
                                    room_location_id = Convert.ToInt32(reader["room_location_id"])
                                });
                            }
                        }
                    }
                }

                return View(rooms);
            }
            catch (Exception ex)
            {
                TempData["Error"] = "Error loading rooms: " + ex.Message;
                return View(new List<dynamic>());
            }
        }

        // KF-16: Search and Filter Rooms
        [HttpGet]
        public IActionResult SearchRooms(int? locationId, int? minCapacity, string? facilities, string? status, DateTime? date, TimeSpan? startTime, TimeSpan? endTime)
        {
            if (!CheckEmployeeAuth())
                return Json(new { success = false, message = "Unauthorized" });

            try
            {
                List<dynamic> rooms = new List<dynamic>();
                using (SqlConnection conn = new SqlConnection(_connectionString))
                {
                    conn.Open();

                    string query = @"SELECT r.*, l.location_code, l.location_plant_name, l.location_block, l.location_floor
                                   FROM rooms r
                                   LEFT JOIN locations l ON r.room_location_id = l.location_id
                                   WHERE r.room_is_active = 1";

                    // Build dynamic query based on filters
                    if (locationId.HasValue)
                        query += " AND r.room_location_id = @LocationId";
                    
                    if (minCapacity.HasValue)
                        query += " AND r.room_capacity >= @MinCapacity";
                    
                    if (!string.IsNullOrEmpty(facilities))
                        query += " AND r.room_facilities LIKE @Facilities";
                    
                    if (!string.IsNullOrEmpty(status))
                        query += " AND r.room_status = @Status";

                    query += " ORDER BY r.room_name";

                    using (SqlCommand cmd = new SqlCommand(query, conn))
                    {
                        if (locationId.HasValue)
                            cmd.Parameters.AddWithValue("@LocationId", locationId.Value);
                        
                        if (minCapacity.HasValue)
                            cmd.Parameters.AddWithValue("@MinCapacity", minCapacity.Value);
                        
                        if (!string.IsNullOrEmpty(facilities))
                            cmd.Parameters.AddWithValue("@Facilities", "%" + facilities + "%");
                        
                        if (!string.IsNullOrEmpty(status))
                            cmd.Parameters.AddWithValue("@Status", status);

                        using (SqlDataReader reader = cmd.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                int roomId = Convert.ToInt32(reader["room_id"]);
                                
                                // Check availability if date and time are provided
                                bool isAvailable = true;
                                if (date.HasValue && startTime.HasValue && endTime.HasValue)
                                {
                                    isAvailable = CheckRoomAvailability(roomId, date.Value, startTime.Value, endTime.Value);
                                }

                                rooms.Add(new
                                {
                                    room_id = roomId,
                                    room_code = reader["room_code"].ToString(),
                                    room_name = reader["room_name"].ToString(),
                                    room_capacity = Convert.ToInt32(reader["room_capacity"]),
                                    room_facilities = reader["room_facilities"]?.ToString(),
                                    room_status = reader["room_status"].ToString(),
                                    location_code = reader["location_code"]?.ToString(),
                                    location_plant_name = reader["location_plant_name"]?.ToString(),
                                    location_block = reader["location_block"] != DBNull.Value ? Convert.ToInt32(reader["location_block"]) : 0,
                                    location_floor = reader["location_floor"] != DBNull.Value ? Convert.ToInt32(reader["location_floor"]) : 0,
                                    is_available = isAvailable
                                });
                            }
                        }
                    }
                }

                return Json(new { success = true, rooms = rooms });
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = "Error: " + ex.Message });
            }
        }

        // Check room availability for specific date and time
        [HttpGet]
        public IActionResult CheckAvailability(int roomId, DateTime date, string startTime, string endTime)
        {
            if (!CheckEmployeeAuth())
                return Json(new { success = false, message = "Unauthorized" });

            try
            {
                TimeSpan start = TimeSpan.Parse(startTime);
                TimeSpan end = TimeSpan.Parse(endTime);

                bool isAvailable = CheckRoomAvailability(roomId, date, start, end);

                return Json(new { success = true, available = isAvailable });
            }
            catch (Exception ex)
            {
                return Json(new { success = false, message = "Error: " + ex.Message });
            }
        }
    }
}