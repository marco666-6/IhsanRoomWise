@using IhsanRoomWise.Function;
@using Microsoft.AspNetCore.Http;
@inject IHttpContextAccessor HttpContextAccessor;

@{
    var session = HttpContextAccessor.HttpContext?.Session;

    var userRole = session?.GetString("UserRole");
    var username = session?.GetString("UserFullName");
    var role = session?.GetString("UserRole");
    var profilePicture = session?.GetString("UserProfilePhoto");
}


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - RoomWise</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap CSS (MUST USE) -->
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />

    <!-- DataTables CSS (MUST USE) -->
    <link rel="stylesheet" href="~/lib/datatables/media/css/jquery.dataTables.min.css" />

    <!-- Select2 CSS (MUST USE) -->
    <link rel="stylesheet" href="~/lib/select2/dist/css/select2.min.css" />
    <link rel="stylesheet" href="~/lib/select2/dist/css/select2-bootstrap-5-theme.min.css" />

    <!-- SweetAlert2 CSS (VERY VERY MUST USE) -->
    <link rel="stylesheet" href="~/lib/sweetalert2/dist/sweetalert2.min.css" />
    
    <!-- Highcharts CSS (MUST USE FOR CHARTS) -->
    <link rel="stylesheet" href="~/lib/highcharts/css/highcharts.css" />

    <!-- FontAwesome CSS (MUST UUUSSSEEE) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />

    @await RenderSectionAsync("Styles", required: false)
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <img src="~/images/assets/logo.png" alt="RoomWise" class="logo-img" />
            </div>
            <div class="brand">RoomWise</div>
        </div>
        
        <nav class="sidebar-nav">
            @{  
                if (userRole == "Admin")
                {
                    <!-- Admin Navigation -->
                    <div class="nav-section">
                        <div class="nav-section-title">Main</div>
                        <div class="nav-item">
                            <a asp-controller="Admin" asp-action="DashboardView" class="nav-link @TagHelperFunction.IsActive(Html, "Admin", "DashboardView")">
                                <i class="fas fa-chart-line"></i>
                                <span>Dashboard</span>
                            </a>
                        </div>
                    </div>
                    
                    <div class="nav-section">
                        <div class="nav-section-title">Management</div>
                        <div class="nav-item">
                            <a asp-controller="Admin" asp-action="UsersView" class="nav-link @TagHelperFunction.IsActive(Html, "Admin", "UsersView")">
                                <i class="fas fa-users"></i>
                                <span>Users</span>
                            </a>
                        </div>
                        <div class="nav-item">
                            <a asp-controller="Admin" asp-action="RoomsView" class="nav-link @TagHelperFunction.IsActive(Html, "Admin", "RoomsView")">
                                <i class="fas fa-door-open"></i>
                                <span>Rooms</span>
                            </a>
                        </div>
                        <div class="nav-item">
                            <a asp-controller="Admin" asp-action="BookingsView" class="nav-link @TagHelperFunction.IsActive(Html, "Admin", "BookingsView")">
                                <i class="fas fa-calendar-alt"></i>
                                <span>Bookings</span>
                            </a>
                        </div>
                        <div class="nav-item">
                            <a asp-controller="Admin" asp-action="FeedbacksView" class="nav-link @TagHelperFunction.IsActive(Html, "Admin", "FeedbacksView")">
                                <i class="fas fa-comment-dots"></i>
                                <span>Feedbacks</span>
                            </a>
                        </div>
                        <div class="nav-item">
                            <a asp-controller="Admin" asp-action="NotificationsView" class="nav-link @TagHelperFunction.IsActive(Html, "Admin", "NotificationsView")">
                                <i class="fas fa-bell"></i>
                                <span>Notifications</span>
                            </a>
                        </div>
                        <div class="nav-item">
                            <a asp-controller="Admin" asp-action="ActivityLogsView" class="nav-link @TagHelperFunction.IsActive(Html, "Admin", "ActivityLogsView")">
                                <i class="fas fa-history"></i>
                                <span>Activity Logs</span>
                            </a>
                        </div>
                    </div>
                    
                    <div class="nav-section">
                        <div class="nav-section-title">Account</div>
                        <div class="nav-item">
                            <a asp-controller="Admin" asp-action="ProfileView" class="nav-link @TagHelperFunction.IsActive(Html, "Admin", "ProfileView")">
                                <i class="fas fa-user-circle"></i>
                                <span>My Profile</span>
                            </a>
                        </div>
                        <div class="nav-item">
                            <a href="#" class="nav-link" id="logoutLink">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Logout</span>
                            </a>
                        </div>
                    </div>
                }
                else if (userRole == "Employee")
                {
                    <!-- Employee Navigation -->
                    <div class="nav-section">
                        <div class="nav-section-title">Main</div>
                        <div class="nav-item">
                            <a asp-controller="Employee" asp-action="DashboardView" class="nav-link @TagHelperFunction.IsActive(Html, "Employee", "DashboardView")">
                                <i class="fas fa-home"></i>
                                <span>Dashboard</span>
                            </a>
                        </div>
                    </div>
                    
                    <div class="nav-section">
                        <div class="nav-section-title">Booking</div>
                        <div class="nav-item">
                            <a asp-controller="Employee" asp-action="FindRoomView" class="nav-link @TagHelperFunction.IsActive(Html, "Employee", "FindRoomView")">
                                <i class="fas fa-search"></i>
                                <span>Find a Room</span>
                            </a>
                        </div>
                        <div class="nav-item">
                            <a asp-controller="Employee" asp-action="MyBookingsView" class="nav-link @TagHelperFunction.IsActive(Html, "Employee", "MyBookingsView")">
                                <i class="fas fa-calendar-check"></i>
                                <span>My Bookings</span>
                            </a>
                        </div>
                        <div class="nav-item">
                            <a asp-controller="Employee" asp-action="MyFeedbacksView" class="nav-link @TagHelperFunction.IsActive(Html, "Employee", "MyFeedbacksView")">
                                <i class="fas fa-star"></i>
                                <span>My Feedbacks</span>
                            </a>
                        </div>
                    </div>
                    
                    <div class="nav-section">
                        <div class="nav-section-title">Information</div>
                        <div class="nav-item">
                            <a asp-controller="Employee" asp-action="NotificationsView" class="nav-link @TagHelperFunction.IsActive(Html, "Employee", "NotificationsView")">
                                <i class="fas fa-bell"></i>
                                <span>Notifications</span>
                            </a>
                        </div>
                        <div class="nav-item">
                            <a asp-controller="Employee" asp-action="MyActivityLogsView" class="nav-link @TagHelperFunction.IsActive(Html, "Employee", "MyActivityLogsView")">
                                <i class="fas fa-clipboard-list"></i>
                                <span>My Activity Logs</span>
                            </a>
                        </div>
                    </div>
                    
                    <div class="nav-section">
                        <div class="nav-section-title">Account</div>
                        <div class="nav-item">
                            <a asp-controller="Employee" asp-action="ProfileView" class="nav-link @TagHelperFunction.IsActive(Html, "Employee", "ProfileView")">
                                <i class="fas fa-user-circle"></i>
                                <span>My Profile</span>
                            </a>
                        </div>
                        <div class="nav-item">
                            <a href="#" class="nav-link" id="logoutLink">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Logout</span>
                            </a>
                        </div>
                    </div>
                }
            }
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Navigation -->
        <div class="top-nav">
            <div class="nav-left">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                
                <div class="page-info">
                    <span class="current-time" id="currentTime"></span>
                </div>
            </div>
            
            <div class="nav-right">
                <div class="user-profile-dropdown">
                    <button class="user-profile-btn" id="userProfileBtn">
                        <div class="user-avatar">
                            @if (!string.IsNullOrEmpty(profilePicture))
                            {
                                <img src="~/images/profiles/@System.IO.Path.GetFileName(profilePicture)" 
                                     alt="Profile" class="avatar-img" 
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                                <span class="avatar-letter" style="display: none;">@(username?[0])</span>
                            }
                            else
                            {
                                <span class="avatar-letter">@(username?[0])</span>
                            }
                        </div>
                        <div class="user-info">
                            <div class="user-name">@username</div>
                            <div class="user-role">@role</div>
                        </div>
                        <i class="fas fa-chevron-down dropdown-arrow"></i>
                    </button>

                    <div class="user-dropdown-menu" id="userDropdownMenu">
                        <a asp-controller="@role" asp-action="ProfileView" class="dropdown-item">
                            <i class="fas fa-user-circle"></i>
                            <span>My Profile</span>
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="dropdown-item" id="logoutLinkDropdown">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page Content -->
        <div class="page-content">
            @RenderBody()
        </div>
    </div>

    <!-- Bootstrap and jQuery Scripts MUST USE AND IS USED -->
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- DataTables JS (MUST USE) -->
    <script src="~/lib/datatables/media/js/jquery.dataTables.min.js"></script>
    
    <!-- Highcharts JS (MUST USE FOR CHARTS) -->
    <script src="~/lib/highcharts/highcharts.js"></script>
    <script src="~/lib/highcharts/highcharts-more.js"></script>
    <script src="~/lib/highcharts/modules/exporting.js"></script>
    <script src="~/lib/highcharts/modules/export-data.js"></script>
    <script src="~/lib/highcharts/modules/accessibility.js"></script>
    
    <!-- Select2 JS (MUST USE) -->
    <script src="~/lib/select2/dist/js/select2.min.js"></script>

    <!-- SweetAlert2 JS (VERY VERY MUST USE) -->
    <script src="~/lib/sweetalert2/dist/sweetalert2.all.min.js"></script>
    
    <!-- Custom JS -->

    <script>
        // ============================================
        // SIDEBAR FUNCTIONALITY
        // ============================================

        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');

        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                sidebar.classList.toggle('collapsed');
                
                // Save state to localStorage
                localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
                
                // Mobile toggle
                if (window.innerWidth <= 768) {
                    sidebar.classList.toggle('mobile-open');
                }
            });
        }

        // Restore sidebar state on page load
        document.addEventListener('DOMContentLoaded', function() {
            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            if (isCollapsed && window.innerWidth > 768) {
                sidebar.classList.add('collapsed');
            }
            
            // Add tooltips to nav links for collapsed sidebar
            addNavTooltips();
        });

        // Add tooltip data attributes to nav links
        function addNavTooltips() {
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                const spanText = link.querySelector('span');
                if (spanText) {
                    link.setAttribute('data-tooltip', spanText.textContent.trim());
                }
            });
        }

        // Close sidebar on mobile when clicking outside
        document.addEventListener('click', function(e) {
            if (window.innerWidth <= 768) {
                if (sidebar && !sidebar.contains(e.target) && !sidebarToggle.contains(e.target)) {
                    sidebar.classList.remove('mobile-open');
                }
            }
        });

        // Handle window resize
        let resizeTimer;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function() {
                if (window.innerWidth > 768) {
                    sidebar.classList.remove('mobile-open');
                }
            }, 250);
        });

        // ============================================
        // USER PROFILE DROPDOWN
        // ============================================

        const userProfileBtn = document.getElementById('userProfileBtn');
        const userDropdown = document.querySelector('.user-profile-dropdown');

        if (userProfileBtn) {
            userProfileBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                userDropdown.classList.toggle('active');
            });
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (userDropdown && !userDropdown.contains(e.target)) {
                userDropdown.classList.remove('active');
            }
        });

        // Close dropdown on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && userDropdown) {
                userDropdown.classList.remove('active');
            }
        });

        // ============================================
        // CURRENT TIME UPDATE
        // ============================================

        function updateTime() {
            const now = new Date();
            const options = {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            const timeString = now.toLocaleString('en-US', options);
            const timeElement = document.getElementById('currentTime');
            if (timeElement) {
                timeElement.textContent = timeString;
            }
        }

        // Update time immediately and then every minute
        updateTime();
        setInterval(updateTime, 60000);

        // ============================================
        // LOGOUT FUNCTIONALITY
        // ============================================

        const logoutLink = document.getElementById('logoutLink');
        const logoutLinkDropdown = document.getElementById('logoutLinkDropdown');

        function handleLogout(e) {
            e.preventDefault();
            
            // Use SweetAlert2 if available, otherwise use confirm
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    title: 'Logout?',
                    text: 'Are you sure you want to logout?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#7aa22e',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: 'Yes, logout',
                    cancelButtonText: 'Cancel',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = '/Auth/LogoutGet';
                    }
                });
            } else {
                if (confirm('Are you sure you want to logout?')) {
                    window.location.href = '/Auth/LogoutGet';
                }
            }
        }

        if (logoutLink) {
            logoutLink.addEventListener('click', handleLogout);
        }

        if (logoutLinkDropdown) {
            logoutLinkDropdown.addEventListener('click', handleLogout);
        }

        // ============================================
        // SMOOTH SCROLL BEHAVIOR
        // ============================================

        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                const href = this.getAttribute('href');
                if (href !== '#' && href.length > 1) {
                    e.preventDefault();
                    const target = document.querySelector(href);
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                }
            });
        });

        // ============================================
        // LOADING STATES FOR NAVIGATION
        // ============================================

        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                const href = this.getAttribute('href');
                if (href && href !== '#' && !href.startsWith('javascript:')) {
                    const icon = this.querySelector('i');
                    if (icon && !icon.classList.contains('fa-spinner')) {
                        const originalClass = icon.className;
                        icon.className = 'fas fa-spinner fa-spin';
                        
                        // Restore original icon after navigation starts
                        setTimeout(() => {
                            icon.className = originalClass;
                        }, 500);
                    }
                }
            });
        });

        // ============================================
        // ENHANCED BUTTON INTERACTIONS
        // ============================================

        // Add ripple effect to buttons and interactive elements
        function createRipple(event) {
            const button = event.currentTarget;
            const ripple = document.createElement('span');
            const rect = button.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = event.clientX - rect.left - size / 2;
            const y = event.clientY - rect.top - size / 2;
            
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = x + 'px';
            ripple.style.top = y + 'px';
            ripple.classList.add('ripple');
            
            button.appendChild(ripple);
            
            setTimeout(() => {
                ripple.remove();
            }, 600);
        }

        // Add ripple effect CSS
        const style = document.createElement('style');
        style.textContent = `
            .ripple {
                position: absolute;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.5);
                transform: scale(0);
                animation: ripple-animation 0.6s ease-out;
                pointer-events: none;
            }
            
            @keyframes ripple-animation {
                to {
                    transform: scale(4);
                    opacity: 0;
                }
            }
            
            .sidebar-toggle,
            .user-profile-btn,
            .btn-primary,
            .btn-secondary {
                position: relative;
                overflow: hidden;
            }
        `;
        document.head.appendChild(style);

        // Apply ripple effect
        document.querySelectorAll('.sidebar-toggle, .user-profile-btn, .btn-primary, .btn-secondary').forEach(button => {
            button.addEventListener('click', createRipple);
        });

        // ============================================
        // ACTIVE PAGE HIGHLIGHTING
        // ============================================

        // Highlight current page in navigation
        function highlightCurrentPage() {
            const currentPath = window.location.pathname;
            const navLinks = document.querySelectorAll('.nav-link');
            
            navLinks.forEach(link => {
                const href = link.getAttribute('href');
                if (href && currentPath.includes(href)) {
                    link.classList.add('active');
                }
            });
        }

        highlightCurrentPage();

        // ============================================
        // FORM ENHANCEMENTS
        // ============================================

        // Add floating label effect for form inputs
        document.querySelectorAll('.form-control').forEach(input => {
            input.addEventListener('focus', function() {
                this.parentElement?.classList.add('focused');
            });
            
            input.addEventListener('blur', function() {
                if (!this.value) {
                    this.parentElement?.classList.remove('focused');
                }
            });
            
            // Check initial state
            if (input.value) {
                input.parentElement?.classList.add('focused');
            }
        });

        // ============================================
        // PERFORMANCE OPTIMIZATIONS
        // ============================================

        // Debounce function for performance
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Throttle function for performance
        function throttle(func, limit) {
            let inThrottle;
            return function(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }

        // ============================================
        // ACCESSIBILITY ENHANCEMENTS
        // ============================================

        // Keyboard navigation for dropdown
        if (userDropdown) {
            const dropdownItems = userDropdown.querySelectorAll('.dropdown-item');
            
            dropdownItems.forEach((item, index) => {
                item.addEventListener('keydown', function(e) {
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        const next = dropdownItems[index + 1];
                        if (next) next.focus();
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        const prev = dropdownItems[index - 1];
                        if (prev) prev.focus();
                        else userProfileBtn.focus();
                    }
                });
            });
        }

        // Tab trap for mobile sidebar
        if (window.innerWidth <= 768) {
            sidebar?.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    sidebar.classList.remove('mobile-open');
                    sidebarToggle?.focus();
                }
            });
        }

        // ============================================
        // ANIMATION ON SCROLL
        // ============================================

        // Fade in elements on scroll
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.animation = 'fadeInUp 0.6s ease forwards';
                }
            });
        }, observerOptions);

        // Observe cards and other elements
        document.querySelectorAll('.card').forEach(card => {
            observer.observe(card);
        });

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        // Show toast notification
        function showToast(message, type = 'info') {
            if (typeof Swal !== 'undefined') {
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.addEventListener('mouseenter', Swal.stopTimer);
                        toast.addEventListener('mouseleave', Swal.resumeTimer);
                    }
                });
                
                Toast.fire({
                    icon: type,
                    title: message
                });
            }
        }

        // Make utility functions globally available
        window.RoomWise = {
            showToast,
            debounce,
            throttle
        };

        // ============================================
        // CONSOLE BRANDING
        // ============================================

        console.log('%cüè¢ RoomWise Management System', 'color: #7aa22e; font-size: 20px; font-weight: bold;');
        console.log('%cVersion 2.0 - Enhanced UI', 'color: #5f7f23; font-size: 12px;');
        
        @await RenderSectionAsync("Scripts", required: false)
    </script>
</body>
</html>