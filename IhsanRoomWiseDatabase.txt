-- Create RoomWise Database
CREATE DATABASE rwdb;
GO

USE rwdb;
GO

-- Users Table (handles login, profiles, roles KF-01,02,03,05,06)
CREATE TABLE users (
    user_id INT IDENTITY(1,1) PRIMARY KEY,
    user_employee_id NVARCHAR(20) UNIQUE NOT NULL,
    user_email NVARCHAR(100) UNIQUE NOT NULL,
    user_password NVARCHAR(255) NOT NULL,
    user_full_name NVARCHAR(150) NOT NULL,
    user_role NVARCHAR(20) NOT NULL CHECK (user_role IN ('Admin', 'Employee')),
    user_dept_name NVARCHAR(100),
    user_is_active BIT NOT NULL DEFAULT 1,
    user_created_at DATETIME2 DEFAULT GETDATE(),
    user_updated_at DATETIME2 DEFAULT GETDATE()
);

-- Locations Table (Plant/Block/Floor hierarchy KF-08,16)
CREATE TABLE locations (
    location_id INT IDENTITY(1,1) PRIMARY KEY,
    location_code NVARCHAR(15) UNIQUE NOT NULL,
    location_plant_name NVARCHAR(50) NOT NULL,
    location_block TINYINT NOT NULL,
    location_floor TINYINT NOT NULL,
    location_is_active BIT NOT NULL DEFAULT 1,
    location_created_at DATETIME2 DEFAULT GETDATE()
);

-- Rooms Table (facilities, status KF-09,10,15,16)
CREATE TABLE rooms (
    room_id INT IDENTITY(1,1) PRIMARY KEY,
    room_code NVARCHAR(20) UNIQUE NOT NULL,
    room_name NVARCHAR(100) NOT NULL,
    room_location_id INT NOT NULL,
    room_capacity INT NOT NULL,
    room_facilities NVARCHAR(500),
    room_status NVARCHAR(20) NOT NULL DEFAULT 'Available' 
        CHECK (room_status IN ('Available', 'Maintenance', 'OutOfService')),
    room_is_active BIT NOT NULL DEFAULT 1,
    room_created_at DATETIME2 DEFAULT GETDATE(),
    room_updated_at DATETIME2 DEFAULT GETDATE(),
    FOREIGN KEY (room_location_id) REFERENCES locations(location_id)
);

-- Bookings Table (core scheduling KF-11,15,17,18,19)
CREATE TABLE bookings (
    booking_id INT IDENTITY(1,1) PRIMARY KEY,
    booking_code NVARCHAR(30) UNIQUE NOT NULL,
    booking_user_id INT NOT NULL,
    booking_room_id INT NOT NULL,
    booking_title NVARCHAR(200) NOT NULL,
    booking_description NVARCHAR(500),
    booking_date DATE NOT NULL,
    booking_start_time TIME NOT NULL,
    booking_end_time TIME NOT NULL,
    booking_status NVARCHAR(20) NOT NULL DEFAULT 'Pending'
        CHECK (booking_status IN ('Pending', 'Confirmed', 'InProgress', 'Completed', 'Cancelled')),
    booking_cancel_reason NVARCHAR(500),
    booking_cancelled_by INT NULL,
    booking_created_at DATETIME2 DEFAULT GETDATE(),
    booking_updated_at DATETIME2 DEFAULT GETDATE(),
    FOREIGN KEY (booking_user_id) REFERENCES users(user_id),
    FOREIGN KEY (booking_room_id) REFERENCES rooms(room_id),
    FOREIGN KEY (booking_cancelled_by) REFERENCES users(user_id)
);

-- Feedbacks Table (post-meeting KF-20)
CREATE TABLE feedbacks (
    feedback_id INT IDENTITY(1,1) PRIMARY KEY,
    feedback_booking_id INT NOT NULL UNIQUE,
    feedback_user_id INT NOT NULL,
    feedback_rating TINYINT NOT NULL CHECK (feedback_rating BETWEEN 1 AND 5),
    feedback_comments NVARCHAR(500),
    feedback_admin_response NVARCHAR(500),
    feedback_admin_responded_by INT NULL,
    feedback_responded_at DATETIME2 NULL,
    feedback_created_at DATETIME2 DEFAULT GETDATE(),
    FOREIGN KEY (feedback_booking_id) REFERENCES bookings(booking_id),
    FOREIGN KEY (feedback_user_id) REFERENCES users(user_id),
    FOREIGN KEY (feedback_admin_responded_by) REFERENCES users(user_id)
);

-- Indexes for performance (KF-15,16,19)
CREATE INDEX IX_bookings_date_time ON bookings(booking_date, booking_start_time, booking_room_id);
CREATE INDEX IX_bookings_user ON bookings(booking_user_id, booking_status);
CREATE INDEX IX_rooms_location_status ON rooms(room_location_id, room_status);

-- Additional Tables for RoomWise System
-- Run this script after creating the main database tables

GO

-- Seed Locations (Plant A Block 1 Floor 1-3)
INSERT INTO locations (location_code, location_plant_name, location_block, location_floor) VALUES
('PLANT-A-B1-F1', 'Plant A', 1, 1),
('PLANT-A-B1-F2', 'Plant A', 1, 2),
('PLANT-A-B1-F3', 'Plant A', 1, 3);

-- Seed Rooms
INSERT INTO rooms (room_code, room_name, room_location_id, room_capacity, room_facilities, room_status) VALUES
('RM-001', 'Meeting Room Alpha', 1, 8, 'Projector,SmartScreen', 'Available'),
('RM-002', 'Conference Room Beta', 1, 15, 'Projector,ScreenBeam,CiscoBar', 'Available'),
('RM-003', 'Board Room Gamma', 2, 20, 'Projector,SmartScreen,CiscoBar', 'Maintenance');

-- Seed Admin User (MD5: admin123)
INSERT INTO users (user_employee_id, user_email, user_password, user_full_name, user_role, user_dept_name) VALUES
('EMP-0001', 'admin@company.com', '0192023a7bbd73250516f069df18b500', 'System Administrator', 'Admin', 'IT Department');

-- Seed Employee Users
INSERT INTO users (user_employee_id, user_email, user_password, user_full_name, user_role, user_dept_name) VALUES
('EMP-0002', 'john.doe@company.com', '827ccb0eea8a706c4c34a16891f84e7b', 'John Doe', 'Employee', 'Engineering'),
('EMP-0003', 'jane.smith@company.com', '827ccb0eea8a706c4c34a16891f84e7b', 'Jane Smith', 'Employee', 'HR');

-- Sample Booking (password: employee123 for both)
INSERT INTO bookings (booking_code, booking_user_id, booking_room_id, booking_title, booking_date, booking_start_time, booking_end_time, booking_status) VALUES
('BK-20251220-001', 2, 1, 'Project Review Meeting', '2025-12-20', '10:00', '11:30', 'Confirmed');

GO

-- Notifications Table (KF-12, KF-21)
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'notifications')
BEGIN
    CREATE TABLE notifications (
        notification_id INT IDENTITY(1,1) PRIMARY KEY,
        notification_title NVARCHAR(200) NOT NULL,
        notification_message NVARCHAR(1000) NOT NULL,
        notification_type NVARCHAR(20) NOT NULL CHECK (notification_type IN ('Info', 'Warning', 'Alert', 'Announcement')),
        notification_target_role NVARCHAR(20) NOT NULL CHECK (notification_target_role IN ('Admin', 'Employee', 'All')),
        notification_is_active BIT NOT NULL DEFAULT 1,
        notification_created_at DATETIME2 DEFAULT GETDATE()
    );
    
    PRINT 'Notifications table created successfully';
END
ELSE
BEGIN
    PRINT 'Notifications table already exists';
END
GO

-- Activity Logs Table (KF-13, KF-22)
IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'activity_logs')
BEGIN
    CREATE TABLE activity_logs (
        log_id INT IDENTITY(1,1) PRIMARY KEY,
        log_user_id INT NOT NULL,
        log_action NVARCHAR(100) NOT NULL,
        log_description NVARCHAR(500) NOT NULL,
        log_created_at DATETIME2 DEFAULT GETDATE(),
        FOREIGN KEY (log_user_id) REFERENCES users(user_id)
    );
    
    PRINT 'Activity logs table created successfully';
END
ELSE
BEGIN
    PRINT 'Activity logs table already exists';
END
GO

-- Create indexes for better performance
IF NOT EXISTS (SELECT * FROM sys.indexes WHERE name = 'IX_notifications_target_role')
BEGIN
    CREATE INDEX IX_notifications_target_role ON notifications(notification_target_role, notification_is_active);
    PRINT 'Index IX_notifications_target_role created';
END
GO

IF NOT EXISTS (SELECT * FROM sys.indexes WHERE name = 'IX_activity_logs_user')
BEGIN
    CREATE INDEX IX_activity_logs_user ON activity_logs(log_user_id, log_created_at);
    PRINT 'Index IX_activity_logs_user created';
END
GO

-- Insert sample notifications
IF NOT EXISTS (SELECT * FROM notifications WHERE notification_id = 1)
BEGIN
    INSERT INTO notifications (notification_title, notification_message, notification_type, notification_target_role, notification_is_active)
    VALUES 
    ('Welcome to RoomWise', 'Welcome to the RoomWise Meeting Room Management System. Book your rooms efficiently and manage your meetings seamlessly.', 'Info', 'All', 1),
    ('System Maintenance Notice', 'The system will undergo scheduled maintenance on Sunday from 2:00 AM to 4:00 AM. Please plan accordingly.', 'Warning', 'All', 1),
    ('New Feature: Real-time Availability', 'You can now check room availability in real-time before making a booking!', 'Announcement', 'Employee', 1);
    
    PRINT 'Sample notifications inserted';
END
GO
