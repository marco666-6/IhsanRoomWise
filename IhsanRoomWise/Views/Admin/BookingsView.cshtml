@model List<dynamic>

@{
    ViewData["Title"] = "Bookings Management";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="page-header">
    <div>
        <h1 class="page-title">Bookings Management</h1>
        <p class="page-description">Manage all meeting room bookings</p>
    </div>
    <div class="page-actions">
        <div class="view-toggle">
            <button class="view-btn active" data-view="table">
                <i class="fas fa-table"></i>
            </button>
            <button class="view-btn" data-view="calendar">
                <i class="fas fa-calendar-alt"></i>
            </button>
            <button class="view-btn" data-view="card">
                <i class="fas fa-th-large"></i>
            </button>
        </div>
        <a asp-action="ExportBookings" class="btn btn-success">
            <i class="fas fa-file-excel me-2"></i> Export
        </a>
    </div>
</div>

<!-- Quick Stats -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="stat-card stat-card-sm">
            <div class="stat-icon-sm bg-primary">
                <i class="fas fa-calendar-check"></i>
            </div>
            <div class="stat-details-sm">
                <div class="stat-value-sm">@Model.Count</div>
                <div class="stat-label-sm">Total Bookings</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card stat-card-sm">
            <div class="stat-icon-sm bg-warning">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-details-sm">
                <div class="stat-value-sm">@Model.Count(b => b.booking_status == "Pending")</div>
                <div class="stat-label-sm">Pending</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card stat-card-sm">
            <div class="stat-icon-sm bg-success">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-details-sm">
                <div class="stat-value-sm">@Model.Count(b => b.booking_status == "Confirmed")</div>
                <div class="stat-label-sm">Confirmed</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card stat-card-sm">
            <div class="stat-icon-sm bg-danger">
                <i class="fas fa-times-circle"></i>
            </div>
            <div class="stat-details-sm">
                <div class="stat-value-sm">@Model.Count(b => b.booking_status == "Cancelled")</div>
                <div class="stat-label-sm">Cancelled</div>
            </div>
        </div>
    </div>
</div>

<!-- Filter Section -->
<div class="filter-section d-flex justify-content-center align-items-center">
    <div class="filter-group d-flex justify-content-start align-items-center gap-3">
        <div class="d-flex flex-column">
            <label>Status</label>
            <select class="filter-select" id="filterStatus" style="min-width:200px !important;">
                <option value="">All Status</option>
                <option value="Pending">Pending</option>
                <option value="Confirmed">Confirmed</option>
                <option value="InProgress">In Progress</option>
                <option value="Completed">Completed</option>
                <option value="Cancelled">Cancelled</option>
            </select>
        </div>
        <div class="d-flex flex-column">
            <label>Room</label>
            <select class="filter-select" id="filterRoom" style="min-width:350px !important;">
                <option value="">All Rooms</option>
                @foreach (var room in Model.Select(b => new { code = b.room_code, name = b.room_name }).Distinct())
                {
                    @if (!string.IsNullOrEmpty(room.code))
                    {
                        <option value="@room.code">@room.code - @room.name</option>
                    }
                }
            </select>
        </div>
        <div class="d-flex flex-column">
            <label>Date Range</label>
            <select class="filter-select" id="filterDate" style="min-width:200px !important;">
                <option value="">All Dates</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
                <option value="upcoming">Upcoming</option>
            </select>
        </div>
    </div>
    
    <div class="filter-actions">
        <button class="btn-primary" onclick="resetFilters()">
            <i class="fas fa-undo"></i> Reset
        </button>
    </div>
</div>

<!-- Table View -->
<div class="card" id="tableView">
    <div class="card-body">
        <div class="table-responsive">
            <table id="bookingsTable" class="table table-hover text-nowrap text-center align-middle">
                <thead>
                    <tr>
                        <th><div class="th-content"><i class="fas fa-barcode me-2"></i>Code</div></th>
                        <th><div class="th-content"><i class="fas fa-heading me-2"></i>Title</div></th>
                        <th><div class="th-content"><i class="fas fa-door-open me-2"></i>Room</div></th>
                        <th><div class="th-content"><i class="fas fa-user me-2"></i>User</div></th>
                        <th><div class="th-content"><i class="fas fa-calendar me-2"></i>Date</div></th>
                        <th><div class="th-content"><i class="fas fa-clock me-2"></i>Time</div></th>
                        <th><div class="th-content"><i class="fas fa-circle-dot me-2"></i>Status</div></th>
                        <th class="text-center"><div class="th-content justify-content-center"><i class="fas fa-tools me-2"></i>Actions</div></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var booking in Model)
                    {
                        <tr data-status="@booking.booking_status" 
                            data-room="@booking.room_code" 
                            data-date="@booking.booking_date.ToString("yyyy-MM-dd")">
                            <td><span class="booking-code">@booking.booking_code</span></td>
                            <td><strong>@booking.booking_title</strong></td>
                            <td>
                                <div class="room-info">
                                    <div class="room-code-sm">@booking.room_code</div>
                                    <div class="room-name-sm">@booking.room_name</div>
                                </div>
                            </td>
                            <td>
                                <div class="user-info">
                                    <div class="user-name">@booking.user_full_name</div>
                                    <div class="user-id">@booking.user_employee_id</div>
                                </div>
                            </td>
                            <td>@booking.booking_date.ToString("MMM dd, yyyy")</td>
                            <td>
                                <span class="time-badge">
                                    @booking.booking_start_time.ToString(@"hh\:mm") - @booking.booking_end_time.ToString(@"hh\:mm")
                                </span>
                            </td>
                            <td>
                                @if (booking.booking_status == "Pending")
                                {
                                    <span class="status-badge status-pending">
                                        <i class="fas fa-circle"></i> Pending
                                    </span>
                                }
                                else if (booking.booking_status == "Confirmed")
                                {
                                    <span class="status-badge status-confirmed">
                                        <i class="fas fa-circle"></i> Confirmed
                                    </span>
                                }
                                else if (booking.booking_status == "InProgress")
                                {
                                    <span class="status-badge status-progress">
                                        <i class="fas fa-circle"></i> In Progress
                                    </span>
                                }
                                else if (booking.booking_status == "Completed")
                                {
                                    <span class="status-badge status-completed">
                                        <i class="fas fa-circle"></i> Completed
                                    </span>
                                }
                                else if (booking.booking_status == "Cancelled")
                                {
                                    <span class="status-badge status-cancelled">
                                        <i class="fas fa-circle"></i> Cancelled
                                    </span>
                                }
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-action btn-action-view" 
                                            onclick='viewBooking(@booking.booking_id, "@booking.booking_code", "@booking.booking_title", "@booking.booking_description", "@booking.booking_date.ToString("yyyy-MM-dd")", "@booking.booking_start_time.ToString(@"hh\:mm")", "@booking.booking_end_time.ToString(@"hh\:mm")", "@booking.room_name", "@booking.user_full_name")'
                                            title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    @if (booking.booking_status == "Pending")
                                    {
                                        <button class="btn-action btn-action-approve" 
                                                onclick="approveBooking(@booking.booking_id)"
                                                title="Approve">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    }
                                    @if (booking.booking_status == "Pending" || booking.booking_status == "Confirmed")
                                    {
                                        <button class="btn-action btn-action-cancel" 
                                                onclick="cancelBooking(@booking.booking_id)"
                                                title="Cancel">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Calendar View - FULL DETAILS -->
<div id="calendarView" style="display: none;">
    <div class="card premium-calendar-card">
        <div class="card-header calendar-header">
            <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Meeting Schedule</h5>
        </div>
        <div class="card-body p-0">
            <div id="bookingCalendar"></div>
        </div>
    </div>
</div>

<!-- Card View -->
<div class="bookings-grid" id="cardView" style="display: none;">
    @foreach (var booking in Model)
    {
        <div class="booking-card-item" 
             data-status="@booking.booking_status" 
             data-room="@booking.room_code" 
             data-date="@booking.booking_date.ToString("yyyy-MM-dd")">
            <div class="booking-card-header">
                <div class="booking-card-title">
                    <h5>@booking.booking_title</h5>
                    <span class="booking-code">@booking.booking_code</span>
                </div>
                @if (booking.booking_status == "Pending")
                {
                    <span class="status-badge status-pending">
                        <i class="fas fa-circle"></i> Pending
                    </span>
                }
                else if (booking.booking_status == "Confirmed")
                {
                    <span class="status-badge status-confirmed">
                        <i class="fas fa-circle"></i> Confirmed
                    </span>
                }
                else if (booking.booking_status == "InProgress")
                {
                    <span class="status-badge status-progress">
                        <i class="fas fa-circle"></i> In Progress
                    </span>
                }
                else if (booking.booking_status == "Completed")
                {
                    <span class="status-badge status-completed">
                        <i class="fas fa-circle"></i> Completed
                    </span>
                }
                else if (booking.booking_status == "Cancelled")
                {
                    <span class="status-badge status-cancelled">
                        <i class="fas fa-circle"></i> Cancelled
                    </span>
                }
            </div>
            <div class="booking-card-body">
                <div class="booking-card-info">
                    <div class="info-item">
                        <i class="fas fa-door-open"></i>
                        <div>
                            <div class="info-label">Room</div>
                            <div class="info-value">@booking.room_name</div>
                            <div class="info-sub">@booking.room_code</div>
                        </div>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-user"></i>
                        <div>
                            <div class="info-label">Booked By</div>
                            <div class="info-value">@booking.user_full_name</div>
                            <div class="info-sub">@booking.user_employee_id</div>
                        </div>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-calendar"></i>
                        <div>
                            <div class="info-label">Date & Time</div>
                            <div class="info-value">@booking.booking_date.ToString("MMM dd, yyyy")</div>
                            <div class="info-sub">@booking.booking_start_time.ToString(@"hh\:mm") - @booking.booking_end_time.ToString(@"hh\:mm")</div>
                        </div>
                    </div>
                </div>
                @if (!string.IsNullOrEmpty(booking.booking_description?.ToString()))
                {
                    <div class="booking-description">
                        <div class="description-label">Description:</div>
                        <p>@booking.booking_description</p>
                    </div>
                }
            </div>
            <div class="booking-card-footer">
                <div class="action-buttons">
                    <button class="btn-action btn-action-view" 
                            onclick='viewBooking(@booking.booking_id, "@booking.booking_code", "@booking.booking_title", "@booking.booking_description", "@booking.booking_date.ToString("yyyy-MM-dd")", "@booking.booking_start_time.ToString(@"hh\:mm")", "@booking.booking_end_time.ToString(@"hh\:mm")", "@booking.room_name", "@booking.user_full_name")'
                            title="View">
                        <i class="fas fa-eye"></i>
                    </button>
                    @if (booking.booking_status == "Pending")
                    {
                        <button class="btn-action btn-action-approve" 
                                onclick="approveBooking(@booking.booking_id)"
                                title="Approve">
                            <i class="fas fa-check"></i>
                        </button>
                    }
                    @if (booking.booking_status == "Pending" || booking.booking_status == "Confirmed")
                    {
                        <button class="btn-action btn-action-cancel" 
                                onclick="cancelBooking(@booking.booking_id)"
                                title="Cancel">
                            <i class="fas fa-times"></i>
                        </button>
                    }
                </div>
            </div>
        </div>
    }
</div>

@section Modals {
<!-- View Booking Modal -->
<div class="modal fade" id="viewBookingModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-header-content">
                    <div class="modal-icon bg-info">
                        <i class="fas fa-eye"></i>
                    </div>
                    <div>
                        <h5 class="modal-title">Booking Details</h5>
                        <p class="modal-subtitle">View booking information</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="detail-label">Booking Code</label>
                        <p class="detail-value" id="viewCode"></p>
                    </div>
                    <div class="col-md-6">
                        <label class="detail-label">Title</label>
                        <p class="detail-value" id="viewTitle"></p>
                    </div>
                    <div class="col-md-6">
                        <label class="detail-label">Room</label>
                        <p class="detail-value" id="viewRoom"></p>
                    </div>
                    <div class="col-md-6">
                        <label class="detail-label">User</label>
                        <p class="detail-value" id="viewUser"></p>
                    </div>
                    <div class="col-md-6">
                        <label class="detail-label">Date</label>
                        <p class="detail-value" id="viewDate"></p>
                    </div>
                    <div class="col-md-6">
                        <label class="detail-label">Time</label>
                        <p class="detail-value" id="viewTime"></p>
                    </div>
                    <div class="col-12">
                        <label class="detail-label">Description</label>
                        <p class="detail-value" id="viewDescription"></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Booking Modal -->
<div class="modal fade" id="cancelBookingModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-header-content">
                    <div class="modal-icon bg-danger">
                        <i class="fas fa-times"></i>
                    </div>
                    <div>
                        <h5 class="modal-title">Cancel Booking</h5>
                        <p class="modal-subtitle">Provide cancellation reason</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="cancelBookingId" />
                <div class="mb-3">
                    <label class="form-label">Cancellation Reason <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="cancelReason" rows="3" placeholder="Please provide a reason for cancellation" required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Close
                </button>
                <button type="button" class="btn btn-danger" onclick="confirmCancelBooking()">
                    <i class="fas fa-ban me-2"></i>Cancel Booking
                </button>
            </div>
        </div>
    </div>
</div>
}

@section Scripts {
    <!-- FullCalendar CSS & JS -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js'></script>
    
    <script>
        let bookingsTable;
        let calendar;
        let currentView = 'table';
        let bookingsData = [];

        $(document).ready(function() {
            // Parse bookings data properly
            // SAFE data parsing
            const rawData = @Html.Raw(Json.Serialize(Model));
            bookingsData = Array.isArray(rawData) ? rawData : [];
            
            console.log('✅ Loaded', bookingsData.length, 'bookings');
            
            initializeDataTable();
            initializeCalendar();
            initializeFilters();
            initializeViewToggle();
        });

        function reInitializeSelect2() {
            $('#createLocation').select2('destroy');
            $('#editLocation').select2('destroy');
            $('#createStatus').select2('destroy');
            $('#editStatus').select2('destroy');
            $('#newStatus').select2('destroy');

            $('#createLocation').select2({
                theme: 'bootstrap-5',
                placeholder: 'Select an option',
                dropdownParent: $('#createRoomModal'),
                allowClear: true
            });

            $('#editLocation').select2({
                theme: 'bootstrap-5',
                placeholder: 'Select an option',
                dropdownParent: $('#editRoomModal'),
                allowClear: true
            });

            $('#createStatus').select2({
                theme: 'bootstrap-5',
                placeholder: 'Select an option',
                dropdownParent: $('#createRoomModal'),
                allowClear: true
            });

            $('#editStatus').select2({
                theme: 'bootstrap-5',
                placeholder: 'Select an option',
                dropdownParent: $('#editRoomModal'),
                allowClear: true
            });

            $('#newStatus').select2({
                theme: 'bootstrap-5',
                placeholder: 'Select an option',
                dropdownParent: $('#changeStatusModal'),
                allowClear: true
            });
        }

        function initializeDataTable() {
            bookingsTable = $('#bookingsTable').DataTable({
                responsive: false,
                scrollX: true,
                pageLength: 25,
                order: [[4, 'desc'], [5, 'desc']],
                language: {
                    search: "",
                    searchPlaceholder: "🔍 Search bookings...",
                    lengthMenu: "Show _MENU_",
                    info: "Showing _START_ to _END_ of _TOTAL_ bookings",
                    emptyTable: "No bookings found",
                    paginate: {
                        previous: "‹",
                        next: "›"
                    }
                },
                dom:
                    "<'row mb-3'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
                    "<'row'<'col-sm-12'tr>>" +
                    "<'row mt-3'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
            });
        }

        // PERFECT CALENDAR - NO BUGS
        // FIXED CALENDAR - SHOWS ALL EVENTS PROPERLY
        function initializeCalendar() {
            const calendarEl = document.getElementById('bookingCalendar');
            
            console.log('📅 Initializing calendar with', bookingsData.length, 'bookings');
            
            // Map bookings to calendar events with CORRECT property names
            const events = bookingsData
                .filter(b => b && b.booking_status !== 'Cancelled') // Filter cancelled
                .map(b => {
                    try {
                        // Handle different date/time formats
                        let dateStr = b.booking_date;
                        if (dateStr && typeof dateStr === 'object' && dateStr.date) {
                            dateStr = dateStr.date.split(' ')[0]; // Extract date from DateTime object
                        } else if (typeof dateStr === 'string') {
                            dateStr = dateStr.split('T')[0]; // Extract date part
                        }
                        
                        // Handle time - might be TimeSpan or string
                        let startTime = b.booking_start_time;
                        let endTime = b.booking_end_time;
                        
                        // Convert TimeSpan objects to HH:mm format
                        if (typeof startTime === 'object' && startTime.hours !== undefined) {
                            startTime = String(startTime.hours).padStart(2, '0') + ':' + String(startTime.minutes).padStart(2, '0');
                        } else if (typeof startTime === 'string' && startTime.includes(':')) {
                            // Already in HH:mm format
                            startTime = startTime.substring(0, 5);
                        } else {
                            startTime = '09:00'; // Default
                        }
                        
                        if (typeof endTime === 'object' && endTime.hours !== undefined) {
                            endTime = String(endTime.hours).padStart(2, '0') + ':' + String(endTime.minutes).padStart(2, '0');
                        } else if (typeof endTime === 'string' && endTime.includes(':')) {
                            endTime = endTime.substring(0, 5);
                        } else {
                            endTime = '10:00'; // Default
                        }
                        
                        const start = `${dateStr}T${startTime}:00`;
                        const end = `${dateStr}T${endTime}:00`;
                        
                        const title = (b.booking_title || 'Untitled').substring(0, 40);
                        const roomCode = b.room_code || '';
                        const status = b.booking_status || 'Pending';
                        
                        return {
                            id: String(b.booking_id || Math.random()),
                            title: `${title}${roomCode ? ` (${roomCode})` : ''}`,
                            start: start,
                            end: end,
                            classNames: [`status-${status.toLowerCase().replace(' ', '')}`],
                            extendedProps: {
                                code: b.booking_code || '',
                                title: b.booking_title || '',
                                description: b.booking_description || '',
                                room: b.room_name || '',
                                roomCode: b.room_code || '',
                                user: b.user_full_name || '',
                                userId: b.user_employee_id || '',
                                status: status,
                                bookingId: b.booking_id
                            }
                        };
                    } catch (error) {
                        console.error('❌ Error parsing booking:', b, error);
                        return null;
                    }
                })
                .filter(e => e !== null); // Remove any failed parses

            console.log('✅ Created', events.length, 'calendar events');
            
            // Initialize FullCalendar
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
                },
                views: {
                    dayGridMonth: { buttonText: 'Month' },
                    timeGridWeek: { buttonText: 'Week' },
                    timeGridDay: { buttonText: 'Day' },
                    listWeek: { buttonText: 'List' }
                },
                events: events,
                height: 750,
                dayMaxEvents: 3,
                eventTimeFormat: {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                },
                slotMinTime: '07:00:00',
                slotMaxTime: '20:00:00',
                allDaySlot: false,
                nowIndicator: true,
                
                // Event rendering with room badge
                eventDidMount: function(info) {
                    const props = info.event.extendedProps;
                    
                    // Add room badge for better visibility
                    if (props.roomCode) {
                        const badge = document.createElement('span');
                        badge.className = 'event-room-badge';
                        badge.textContent = props.roomCode;
                        info.el.appendChild(badge);
                    }
                    
                    // Enhanced tooltip
                    const tooltipContent = `
                        📌 ${props.title}
                        🚪 ${props.room || 'N/A'} (${props.roomCode || 'N/A'})
                        👤 ${props.user || 'N/A'}
                        ⏰ ${info.event.start.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'})} - ${info.event.end ? info.event.end.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'}) : 'N/A'}
                        📊 Status: ${props.status}
                    `.trim();
                    
                    info.el.title = tooltipContent;
                },
                
                // Click event to view details
                eventClick: function(info) {
                    const props = info.event.extendedProps;
                    const start = info.event.start;
                    const end = info.event.end;
                    
                    viewBooking(
                        props.bookingId,
                        props.code,
                        props.title,
                        props.description,
                        start.toISOString().split('T')[0],
                        start.toTimeString().slice(0, 5),
                        end ? end.toTimeString().slice(0, 5) : 'N/A',
                        props.room,
                        props.user
                    );
                },
                
                // Prevent date selection
                selectable: false,
                
                // Loading indicator
                loading: function(isLoading) {
                    if (isLoading) {
                        console.log('📅 Calendar loading...');
                    } else {
                        console.log('✅ Calendar loaded successfully');
                    }
                }
            });
            
            calendar.render();
            console.log('🎉 Calendar rendered with', events.length, 'events visible');
        }

        function getStatusColor(status) {
            const colors = {
                'Pending': '#f59e0b',
                'Confirmed': '#10b981',
                'InProgress': '#3b82f6',
                'Completed': '#6366f1',
                'Cancelled': '#ef4444'
            };
            return colors[status] || '#6b7280';
        }

        function initializeFilters() {
            $('#filterStatus, #filterRoom, #filterDate').on('change', applyFilters);
        }

        function initializeViewToggle() {
            $('.view-btn').on('click', function() {
                const view = $(this).data('view');
                switchView(view);
            });
        }

        function switchView(view) {
            currentView = view;
            $('.view-btn').removeClass('active');
            $(`.view-btn[data-view="${view}"]`).addClass('active');

            $('#tableView, #calendarView, #cardView').hide();
            
            if (view === 'table') {
                $('#tableView').show();
            } else if (view === 'calendar') {
                $('#calendarView').show();
                setTimeout(() => calendar.render(), 100);
            } else {
                $('#cardView').show();
            }
            
            applyFilters();
        }

        function applyFilters() {
            const status = $('#filterStatus').val();
            const room = $('#filterRoom').val();
            const dateRange = $('#filterDate').val();
            const today = new Date();
            today.setHours(0,0,0,0);

            if (currentView === 'table') {
                bookingsTable.rows().every(function() {
                    const row = $(this.node());
                    let show = true;

                    if (status && row.data('status') !== status) show = false;
                    if (room && row.data('room') !== room) show = false;
                    
                    if (dateRange) {
                        const bookingDate = new Date(row.data('date'));
                        bookingDate.setHours(0,0,0,0);
                        
                        if (dateRange === 'today' && bookingDate.getTime() !== today.getTime()) show = false;
                        if (dateRange === 'week') {
                            const weekEnd = new Date(today);
                            weekEnd.setDate(weekEnd.getDate() + 7);
                            if (bookingDate < today || bookingDate > weekEnd) show = false;
                        }
                        if (dateRange === 'month') {
                            const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                            if (bookingDate < today || bookingDate > monthEnd) show = false;
                        }
                        if (dateRange === 'upcoming' && bookingDate < today) show = false;
                    }

                    row.toggle(show);
                });
            } else if (currentView === 'card') {
                $('.booking-card-item').each(function() {
                    const card = $(this);
                    let show = true;

                    if (status && card.data('status') !== status) show = false;
                    if (room && card.data('room') !== room) show = false;
                    
                    if (dateRange) {
                        const bookingDate = new Date(card.data('date'));
                        bookingDate.setHours(0,0,0,0);
                        
                        if (dateRange === 'today' && bookingDate.getTime() !== today.getTime()) show = false;
                        if (dateRange === 'week') {
                            const weekEnd = new Date(today);
                            weekEnd.setDate(weekEnd.getDate() + 7);
                            if (bookingDate < today || bookingDate > weekEnd) show = false;
                        }
                        if (dateRange === 'month') {
                            const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                            if (bookingDate < today || bookingDate > monthEnd) show = false;
                        }
                        if (dateRange === 'upcoming' && bookingDate < today) show = false;
                    }

                    card.toggle(show);
                });
            } else if (currentView === 'calendar' && calendar) {
                // FIXED: Properly filter calendar events
                calendar.getEvents().forEach(event => {
                    const props = event.extendedProps;
                    let show = true;

                    // Status filter
                    if (status && props.status !== status) show = false;
                    
                    // Room filter - check room code
                    if (room && props.roomCode !== room) show = false;
                    
                    // Date range filter
                    if (dateRange) {
                        const eventDate = new Date(event.start);
                        eventDate.setHours(0,0,0,0);
                        
                        if (dateRange === 'today' && eventDate.getTime() !== today.getTime()) show = false;
                        if (dateRange === 'week') {
                            const weekEnd = new Date(today);
                            weekEnd.setDate(weekEnd.getDate() + 7);
                            if (eventDate < today || eventDate > weekEnd) show = false;
                        }
                        if (dateRange === 'month') {
                            const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                            if (eventDate < today || eventDate > monthEnd) show = false;
                        }
                        if (dateRange === 'upcoming' && eventDate < today) show = false;
                    }

                    // Show/hide event
                    event.setProp('display', show ? 'auto' : 'none');
                });
            }
        }

        function resetFilters() {
            $('#filterStatus, #filterRoom, #filterDate').val('').trigger('change');
            $('#filterStatus, #filterRoom, #filterDate').empty();
            if (currentView === 'table') {
                bookingsTable.rows().every(function() {
                    $(this.node()).show();
                });
            } else if (currentView === 'card') {
                $('.booking-card-item').show();
            }
        }
        
        function viewBooking(id, code, title, description, date, startTime, endTime, room, user) {
            $('#viewCode').text(code);
            $('#viewTitle').text(title);
            $('#viewRoom').text(room);
            $('#viewUser').text(user);
            $('#viewDate').text(date);
            $('#viewTime').text(startTime + ' - ' + endTime);
            $('#viewDescription').text(description || 'No description provided');
            
            const modal = new bootstrap.Modal(document.getElementById('viewBookingModal'));
            modal.show();
        }
        
        function approveBooking(bookingId) {
            Swal.fire({
                title: 'Approve Booking?',
                text: 'Are you sure you want to approve this booking?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, approve it',
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#6b7280'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '@Url.Action("ApproveBooking", "Admin")',
                        type: 'POST',
                        data: { bookingId: bookingId },
                        success: function(response) {
                            if (response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Success!',
                                    text: response.message,
                                    confirmButtonColor: '#7aa22e'
                                }).then(() => location.reload());
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: response.message,
                                    confirmButtonColor: '#7aa22e'
                                });
                            }
                        }
                    });
                }
            });
        }
        
        function cancelBooking(bookingId) {
            $('#cancelBookingId').val(bookingId);
            $('#cancelReason').val('');
            
            const modal = new bootstrap.Modal(document.getElementById('cancelBookingModal'));
            modal.show();
        }
        
        function confirmCancelBooking() {
            const bookingId = $('#cancelBookingId').val();
            const reason = $('#cancelReason').val().trim();
            if (!reason) {
                Swal.fire({
                    icon: 'error',
                    title: 'Missing Information',
                    text: 'Please provide a cancellation reason',
                    confirmButtonColor: '#7aa22e'
                });
                return;
            }
            
            $.ajax({
                url: '@Url.Action("CancelBooking", "Admin")',
                type: 'POST',
                data: { 
                    bookingId: bookingId,
                    reason: reason
                },
                success: function(response) {
                    if (response.success) {
                        bootstrap.Modal.getInstance(document.getElementById('cancelBookingModal')).hide();
                        Swal.fire({
                            icon: 'success',
                            title: 'Success!',
                            text: response.message,
                            confirmButtonColor: '#7aa22e'
                        }).then(() => location.reload());
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: response.message,
                            confirmButtonColor: '#7aa22e'
                        });
                    }
                }
            });
        }
    </script>
}

@section Styles {
    <style>
    /* Base Styles from RoomsView */
    
    /* Page Header, Stats, Filters, Modals, Form Controls */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 2rem;
    }

    .page-actions {
        display: flex;
        gap: 0.75rem;
    }

    /* Small Stat Cards */
    .stat-card-sm {
        background: var(--white);
        border-radius: var(--radius-md);
        padding: 1.25rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        border: 1px solid rgba(122,162,46,0.08);
        transition: all 0.2s;
    }

    .stat-card-sm:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .stat-icon-sm {
        width: 48px;
        height: 48px;
        min-width: 48px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        color: var(--white);
    }

    .stat-icon-sm.bg-primary { background: linear-gradient(135deg, #7aa22e 0%, #5f7f23 100%); }
    .stat-icon-sm.bg-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .stat-icon-sm.bg-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
    .stat-icon-sm.bg-info { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }

    .stat-details-sm {
        flex: 1;
    }

    .stat-value-sm {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--gray-800);
        line-height: 1;
        font-family: 'Poppins', sans-serif;
    }

    .stat-label-sm {
        font-size: 0.8125rem;
        color: var(--gray-600);
        margin-top: 0.25rem;
        font-weight: 500;
    }

    /* Table Header Enhancements */
    .th-content {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8125rem;
        white-space: nowrap;
    }

    .th-content i {
        opacity: 0.6;
        font-size: 0.875rem;
    }

    .view-toggle {
        display: flex;
        gap: 0.5rem;
        background: var(--gray-100);
        padding: 0.25rem;
        border-radius: 8px;
    }

    .view-btn {
        padding: 0.5rem 0.75rem;
        border: none;
        background: transparent;
        color: var(--gray-600);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 1rem;
    }

    .view-btn:hover {
        color: var(--primary);
        background: rgba(122, 162, 46, 0.1);
    }

    .view-btn.active {
        background: var(--white);
        color: var(--primary);
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* Status Badges */
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        white-space: nowrap;
    }

    .status-badge i {
        font-size: 0.5rem;
    }

    .status-available {
        background: rgba(16, 185, 129, 0.1);
        color: #059669;
        border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .status-available i {
        color: #059669;
        animation: pulse 2s infinite;
    }

    .status-maintenance {
        background: rgba(245, 158, 11, 0.1);
        color: #d97706;
        border: 1px solid rgba(245, 158, 11, 0.2);
    }

    .status-out {
        background: rgba(239, 68, 68, 0.1);
        color: #dc2626;
        border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .status-active {
        background: rgba(16, 185, 129, 0.1);
        color: #059669;
        border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .status-active i {
        animation: pulse 2s infinite;
    }

    .status-inactive {
        background: rgba(107, 114, 128, 0.1);
        color: #6b7280;
        border: 1px solid rgba(107, 114, 128, 0.2);
    }

    .room-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 1rem;
        border-top: 1px solid var(--gray-200);
    }

    .btn-action {
        width: 32px;
        height: 32px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.875rem;
    }

    .btn-action-edit {
        background: rgba(59, 130, 246, 0.1);
        color: #2563eb;
    }

    .btn-action-edit:hover {
        background: rgba(59, 130, 246, 0.2);
        transform: translateY(-2px);
    }

    .btn-action-toggle {
        background: rgba(245, 158, 11, 0.1);
        color: #d97706;
    }

    .btn-action-toggle:hover {
        background: rgba(245, 158, 11, 0.2);
        transform: translateY(-2px);
    }

    .btn-action-key {
        background: rgba(107, 114, 128, 0.1);
        color: #6b7280;
    }

    .btn-action-key:hover {
        background: rgba(107, 114, 128, 0.2);
        transform: translateY(-2px);
    }

    @@keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* Modal Enhancements */
    .modal-header-content {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .modal-icon {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--white);
        font-size: 1.25rem;
    }

    .modal-icon.bg-info {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }

    .modal-subtitle {
        font-size: 0.8125rem;
        color: var(--gray-600);
        margin: 0.25rem 0 0 0;
    }

    .form-label {
        font-weight: 500;
        font-size: 0.8125rem;
        color: var(--gray-700);
        margin-bottom: 0.25rem;
    }

    /* Form Controls */
    .form-control,
    .form-select {
        font-size: 0.875rem;
        border-radius: 8px;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--gray-300);
        transition: all 0.2s ease;
    }

    .form-control::placeholder {
        color: var(--gray-400);
        font-size: 0.8125rem;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 0.2rem rgba(122, 162, 46, 0.15);
    }

    /* Modal Footer Buttons */
    .modal-footer {
        border-top: 1px solid var(--gray-200);
        padding-top: 1rem;
    }

    .modal-footer .btn {
        font-size: 0.875rem;
        padding: 0.5rem 1rem;
        border-radius: 8px;
    }

    /* Table Row Hover */
    .table-hover tbody tr:hover {
        background-color: rgba(122, 162, 46, 0.04);
    }

    /* Responsive Tweaks */
    @@media (max-width: 768px) {
        .page-header {
            flex-direction: column;
            gap: 1rem;
        }

        .page-actions {
            width: 100%;
            justify-content: flex-start;
        }

        .stat-card-sm {
            padding: 1rem;
        }

        .stat-value-sm {
            font-size: 1.5rem;
        }

        .action-buttons {
            gap: 0.25rem;
        }
    }

    /* Booking-Specific Styles */
    
    /* Booking Code */
    /* Booking Code */
    .booking-code {
        font-family: 'Courier New', monospace;
        font-size: 0.8125rem;
        color: var(--gray-600);
        background: var(--gray-50);
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-weight: 600;
    }

    /* Room & User Info in Table */
    .room-info, .user-info {
        line-height: 1.3;
    }

    .room-code-sm, .user-name {
        font-weight: 500;
        color: var(--gray-800);
        font-size: 0.875rem;
    }

    .room-name-sm, .user-id {
        font-size: 0.75rem;
        color: var(--gray-600);
    }

    /* Time Badge */
    .time-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.375rem 0.75rem;
        background: rgba(99, 102, 241, 0.1);
        color: #4f46e5;
        border-radius: 6px;
        font-size: 0.8125rem;
        font-weight: 600;
        font-family: 'Courier New', monospace;
    }

    /* Status Badges - Booking Specific */
    .status-pending {
        background: rgba(245, 158, 11, 0.1);
        color: #d97706;
        border: 1px solid rgba(245, 158, 11, 0.2);
    }

    .status-pending i {
        color: #d97706;
        animation: pulse 2s infinite;
    }

    .status-confirmed {
        background: rgba(16, 185, 129, 0.1);
        color: #059669;
        border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .status-confirmed i {
        color: #059669;
    }

    .status-progress {
        background: rgba(59, 130, 246, 0.1);
        color: #2563eb;
        border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .status-progress i {
        color: #2563eb;
        animation: pulse 2s infinite;
    }

    .status-completed {
        background: rgba(99, 102, 241, 0.1);
        color: #4f46e5;
        border: 1px solid rgba(99, 102, 241, 0.2);
    }

    .status-cancelled {
        background: rgba(239, 68, 68, 0.1);
        color: #dc2626;
        border: 1px solid rgba(239, 68, 68, 0.2);
    }

    /* Action Buttons - Booking Specific */
    .btn-action-view {
        background: rgba(59, 130, 246, 0.1);
        color: #2563eb;
    }

    .btn-action-view:hover {
        background: rgba(59, 130, 246, 0.2);
        transform: translateY(-2px);
    }

    .btn-action-approve {
        background: rgba(16, 185, 129, 0.1);
        color: #059669;
    }

    .btn-action-approve:hover {
        background: rgba(16, 185, 129, 0.2);
        transform: translateY(-2px);
    }

    .btn-action-cancel {
        background: rgba(239, 68, 68, 0.1);
        color: #dc2626;
    }

    .btn-action-cancel:hover {
        background: rgba(239, 68, 68, 0.2);
        transform: translateY(-2px);
    }

    /* Card View - Booking Cards */
    .bookings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
        gap: 1.25rem;
    }

    .booking-card-item {
        background: var(--white);
        border-radius: var(--radius-lg);
        padding: 1.25rem;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--gray-200);
        transition: all 0.2s;
    }

    .booking-card-item:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-md);
        border-color: rgba(122, 162, 46, 0.3);
    }

    .booking-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--gray-200);
    }

    .booking-card-title h5 {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--gray-800);
        margin: 0 0 0.25rem 0;
    }

    .booking-card-body {
        margin-bottom: 1rem;
    }

    .booking-card-info {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .info-item {
        display: flex;
        gap: 0.75rem;
    }

    .info-item i {
        width: 20px;
        color: var(--primary);
        font-size: 1rem;
        margin-top: 0.125rem;
    }

    .info-label {
        font-size: 0.75rem;
        color: var(--gray-600);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 600;
    }

    .info-value {
        font-size: 0.9375rem;
        color: var(--gray-800);
        font-weight: 600;
    }

    .info-sub {
        font-size: 0.8125rem;
        color: var(--gray-600);
    }

    .booking-description {
        padding-top: 0.75rem;
        border-top: 1px solid var(--gray-200);
    }

    .description-label {
        font-size: 0.75rem;
        color: var(--gray-600);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
    }

    .booking-description p {
        font-size: 0.875rem;
        color: var(--gray-700);
        margin: 0;
        line-height: 1.5;
    }

    .booking-card-footer {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        padding-top: 1rem;
        border-top: 1px solid var(--gray-200);
    }

    /* Calendar View Customization */
    /* PREMIUM CALENDAR - ZERO BUGS */
    
    .premium-calendar-card {
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 20px 60px -10px rgba(0,0,0,0.2);
        border: none;
        background: #fff;
    }

    #bookingCalendar {
        font-family: 'Inter', system-ui, sans-serif;
    }

    /* Header */
    .fc .fc-toolbar {
        background: linear-gradient(135deg, #7aa22e 0%, #5f7f23 100%);
        padding: 1.5rem 2rem;
        margin: 0;
    }

    .fc .fc-toolbar-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: white;
    }

    .fc .fc-button {
        background: rgba(255,255,255,0.2) !important;
        border: 1px solid rgba(255,255,255,0.3) !important;
        color: white !important;
        border-radius: 12px;
        padding: 0.75rem 1.5rem !important;
        margin: 0 0.25rem;
        font-weight: 600;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
    }

    .fc .fc-button:hover {
        background: rgba(255,255,255,0.4) !important;
        transform: translateY(-2px);
    }

    .fc .fc-button-active {
        background: white !important;
        color: #667eea !important;
    }

    /* Days Grid */
    .fc .fc-col-header-cell {
        background: #f8fafc;
        border: none;
        padding: 1rem 0.75rem;
        font-weight: 600;
        font-size: 0.8rem;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .fc .fc-daygrid-day {
        border: 1px solid #f1f5f9;
        padding: 0.75rem;
        transition: all 0.2s ease;
    }

    .fc .fc-daygrid-day:hover {
        background: #f8fafc;
        border-color: #e2e8f0;
    }

    .fc .fc-daygrid-day.fc-day-today {
        background: linear-gradient(135deg, #10b98120, #05966910) !important;
        border-color: #10b981 !important;
        position: relative;
    }

    .fc .fc-daygrid-day.fc-day-today::after {
        content: 'TODAY';
        position: absolute;
        top: 0.5rem;
        left: 0.5rem;
        background: #10b981;
        color: white;
        padding: 0.2rem 0.5rem;
        border-radius: 6px;
        font-size: 0.65rem;
        font-weight: 700;
    }

    /* PERFECT EVENTS */
    .fc .fc-daygrid-event {
        border: none !important;
        border-radius: 8px !important;
        padding: 0.4rem 0.6rem !important;
        margin: 0.1rem 0.2rem !important;
        font-size: 0.65rem !important;
        font-weight: 600 !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: all 0.3s cubic-bezier(0.4,0,0.2,1);
        position: relative;
        overflow: hidden;
    }

    .fc .fc-daygrid-event:hover {
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        z-index: 10;
        color: white;
        cursor: pointer;
    }

    .fc .fc-daygrid-event .fc-event-title {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Status Colors */
    .status-pending { background: linear-gradient(135deg, #f59e0b, #d97706) !important; color: white; }
    .status-confirmed { background: linear-gradient(135deg, #10b981, #059669) !important; color: white; }
    .status-inprogress { background: linear-gradient(135deg, #3b82f6, #2563eb) !important; color: white; }
    .status-completed { background: linear-gradient(135deg, #8b5cf6, #7c3aed) !important; color: white; }
    .status-cancelled { 
        background: linear-gradient(135deg, transparent, transparent) !important; 
        border: 2px solid #ef4444 !important; 
        color: #ef4444 !important;
    }

    /* Room Badge */
    .event-room-badge {
        position: absolute;
        top: 1px;
        right: 3px;
        background: rgba(255,255,255,0.9);
        color: #64748b;
        padding: 0.1rem 0.3rem;
        border-radius: 3px;
        font-size: 0.45rem;
        font-weight: 700;
        border: 1px solid #e2e8f0;
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .fc .fc-toolbar { padding: 1rem; }
        .fc .fc-toolbar-title { font-size: 1.25rem; }
        .fc .fc-daygrid-event { font-size: 0.7rem !important; padding: 0.3rem 0.4rem !important; }
    }

    /* Modal Details */
    .detail-label {
        font-size: 0.75rem;
        color: var(--gray-600);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .detail-value {
        font-size: 0.9375rem;
        color: var(--gray-800);
        font-weight: 500;
        margin: 0;
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .bookings-grid {
            grid-template-columns: 1fr;
        }

        .booking-card-header {
            flex-direction: column;
            gap: 0.75rem;
        }

        .page-actions {
            flex-direction: column;
            width: 100%;
        }

        .view-toggle {
            width: 100%;
            justify-content: center;
        }
    }
    </style>
}