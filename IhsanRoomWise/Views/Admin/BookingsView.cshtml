@* Views/Admin/BookingsView.cshtml *@
@model dynamic
@{
    ViewData["Title"] = "Bookings Management";
}

<style>
    /* Reuse all CSS from RoomsView - no need to repeat */
    .page-header {
        background: linear-gradient(135deg, #ffffff 0%, #f5f9f0 100%);
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border: 1px solid rgba(122, 162, 46, 0.1);
    }

    .page-header h1 {
        color: #2d3e1f;
        font-size: 2rem;
        font-weight: 700;
        margin: 0 0 0.5rem 0;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .page-header h1 i {
        color: #7aa22e;
        font-size: 2rem;
    }

    .page-header p {
        color: #6b7280;
        margin: 0;
        font-size: 0.9375rem;
    }

    .toolbar {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        border: 1px solid #e5e7eb;
    }

    .toolbar-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .toolbar-left {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        flex: 1;
    }

    .search-box {
        position: relative;
        min-width: 300px;
        flex: 1;
        max-width: 610px;
    }

    .search-box input {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 2.75rem;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        font-size: 0.9375rem;
        transition: all 0.2s;
    }

    .search-box input:focus {
        outline: none;
        border-color: #7aa22e;
        box-shadow: 0 0 0 3px rgba(122, 162, 46, 0.1);
    }

    .search-box i {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        font-size: 1rem;
    }

    .filter-group {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .filter-select {
        min-width: 300px;
        padding: 0.75rem 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        font-size: 0.9375rem;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .search-and-filters {
        display: flex;
        flex-direction: column;
        gap: 0.75rem; /* spacing between search & filters */
    }

    .filter-select:focus {
        outline: none;
        border-color: #7aa22e;
        box-shadow: 0 0 0 3px rgba(122, 162, 46, 0.1);
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
        font-weight: 600;
        font-size: 0.9375rem;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
        white-space: nowrap;
    }

    .btn-primary {
        background: linear-gradient(135deg, #7aa22e 0%, #5f7f23 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(122, 162, 46, 0.25);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(122, 162, 46, 0.35);
    }

    .btn-secondary {
        background: white;
        color: #374151;
        border: 2px solid #e5e7eb;
    }

    .btn-secondary:hover {
        border-color: #7aa22e;
        color: #7aa22e;
        transform: translateY(-2px);
    }

    .btn-success {
        background: #10b981;
        color: white;
    }

    .btn-warning {
        background: #f59e0b;
        color: white;
    }

    .btn-danger {
        background: #ef4444;
        color: white;
    }

    .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
    }

    .card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        border: 1px solid #e5e7eb;
        overflow: hidden;
    }

    .card-body {
        padding: 1.5rem;
    }

    .table-container {
        overflow-x: auto;
    }

    table.dataTable {
        width: 100% !important;
        border-collapse: separate;
        border-spacing: 0;
    }

    table.dataTable thead th {
        background: linear-gradient(135deg, #f8faf5 0%, #f0f4ef 100%);
        color: #2d3e1f;
        font-weight: 600;
        padding: 1rem;
        border-bottom: 2px solid #7aa22e;
        text-transform: uppercase;
        font-size: 0.8125rem;
        letter-spacing: 0.05em;
    }

    table.dataTable tbody td {
        padding: 1rem;
        vertical-align: middle;
        border-bottom: 1px solid #f3f4f6;
    }

    table.dataTable tbody tr {
        transition: all 0.2s;
    }

    table.dataTable tbody tr:hover {
        background: #f8faf5;
    }

    .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.8125rem;
        font-weight: 600;
        white-space: nowrap;
    }

    .badge-success {
        background: #d1fae5;
        color: #065f46;
    }

    .badge-danger {
        background: #fee2e2;
        color: #991b1b;
    }

    .badge-admin {
        background: #dbeafe;
        color: #1e40af;
    }

    .badge-employee {
        background: #e0e7ff;
        color: #4338ca;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .btn-icon {
        width: 36px;
        height: 36px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-icon:hover {
        transform: translateY(-2px);
    }

    .btn-icon.btn-edit {
        background: #dbeafe;
        color: #1e40af;
    }

    .btn-icon.btn-edit:hover {
        background: #3b82f6;
        color: white;
    }

    .btn-icon.btn-reset {
        background: #fed7aa;
        color: #92400e;
    }

    .btn-icon.btn-reset:hover {
        background: #f59e0b;
        color: white;
    }

    .btn-icon.btn-toggle {
        background: #fce7f3;
        color: #831843;
    }

    .btn-icon.btn-toggle:hover {
        background: #ec4899;
        color: white;
    }

    .modal-content {
        border-radius: 16px;
        border: none;
        box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }

    .modal-header {
        background: linear-gradient(135deg, #f8faf5 0%, #f0f4ef 100%);
        border-bottom: 2px solid #7aa22e;
        padding: 1.5rem;
        border-radius: 16px 16px 0 0;
    }

    .modal-title {
        color: #2d3e1f;
        font-weight: 700;
        font-size: 1.25rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .modal-title i {
        color: #7aa22e;
    }

    .modal-body {
        padding: 2rem;
    }

    .modal-footer {
        padding: 1.5rem;
        border-top: 1px solid #e5e7eb;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        color: #374151;
        font-weight: 600;
        font-size: 0.9375rem;
    }

    .form-control {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        font-size: 0.9375rem;
        transition: all 0.2s;
    }

    .form-control:focus {
        outline: none;
        border-color: #7aa22e;
        box-shadow: 0 0 0 3px rgba(122, 162, 46, 0.1);
    }

    .form-check {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
    }

    .form-check-input {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }

    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .stat-card {
        background: linear-gradient(135deg, #ffffff 0%, #f8faf5 100%);
        border: 1px solid rgba(122, 162, 46, 0.1);
        border-radius: 12px;
        padding: 1.25rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: all 0.2s;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(122, 162, 46, 0.15);
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .stat-icon.success {
        background: #d1fae5;
        color: #065f46;
    }

    .stat-icon.primary {
        background: #dbeafe;
        color: #1e40af;
    }

    .stat-icon.warning {
        background: #fed7aa;
        color: #92400e;
    }

    .stat-content h3 {
        font-size: 1.75rem;
        font-weight: 700;
        color: #1f2937;
        margin: 0;
    }

    .stat-content p {
        font-size: 0.875rem;
        color: #6b7280;
        margin: 0;
    }

    @@media (max-width: 768px) {
        .toolbar-row {
            flex-direction: column;
            align-items: stretch;
        }

        .search-box {
            min-width: 100%;
            max-width: 100%;
        }

        .filter-group {
            width: 100%;
        }

        .filter-select {
            flex: 1;
        }
    }
/* Additional Calendar-specific styles */
#calendar {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    border: 1px solid #e5e7eb;
    margin-bottom: 1.5rem;
}

.fc-event {
    border-radius: 6px !important;
    font-size: 0.875rem !important;
    font-weight: 600 !important;
}

.fc-event-title {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.booking-details {
    display: flex;
    gap: 1rem;
    margin-top: 0.5rem;
    font-size: 0.8125rem;
    color: #6b7280;
}

.stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.stat-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8faf5 100%);
    border: 1px solid rgba(122, 162, 46, 0.1);
    border-radius: 12px;
    padding: 1.25rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: all 0.2s;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(122, 162, 46, 0.15);
}

.stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

.stat-icon.primary { background: #dbeafe; color: #1e40af; }
.stat-icon.success { background: #d1fae5; color: #065f46; }
.stat-icon.warning { background: #fed7aa; color: #92400e; }

.booking-status-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
}

.status-confirmed { background: #28a745; color: white; }
.status-pending { background: #ffc107; color: #000; }
.status-progress { background: #17a2b8; color: white; }
.status-cancelled { background: #dc3545; color: white; }
</style>

<!-- Page Header -->
<div class="page-header">
    <h1><i class="fas fa-calendar-check"></i> Booking Management</h1>
    <p>Manage all room bookings, view calendar, and update statuses</p>
</div>

<!-- Statistics -->
<div class="stats-row">
    <div class="stat-card">
        <div class="stat-icon primary"><i class="fas fa-calendar-day"></i></div>
        <div class="stat-content">
            <h3 id="totalBookings">0</h3>
            <p>Total Bookings</p>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon success"><i class="fas fa-check-circle"></i></div>
        <div class="stat-content">
            <h3 id="todayBookings">0</h3>
            <p>Today's Bookings</p>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon warning"><i class="fas fa-clock"></i></div>
        <div class="stat-content">
            <h3 id="activeBookings">0</h3>
            <p>Active Now</p>
        </div>
    </div>
</div>

<!-- Calendar & Controls -->
<div class="toolbar">
    <div class="toolbar-row">
        <div class="toolbar-left">
            <div class="search-and-filters">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Search by title, code, or user...">
                </div>
                <div class="filter-group">
                    <select id="statusFilter" class="filter-select">
                        <option value="">All Status</option>
                        <option value="Confirmed">Confirmed</option>
                        <option value="Pending">Pending</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                    <select id="roomFilter" class="filter-select">
                        <option value="">All Rooms</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="toolbar-right">
            <button class="btn btn-secondary" id="exportBtn">
                <i class="fas fa-file-excel"></i> Export
            </button>
            <button class="btn btn-primary" id="addBookingBtn">
                <i class="fas fa-plus"></i> Add Booking
            </button>
        </div>
    </div>
    <hr />
    <div class="toolbar-row d-flex justify-content-center align-items-center text-center mt-4">
        <div class="filter-group">
            <button class="btn btn-primary" id="calendarBtn" title="Toggle Calendar/List View">
                <i class="fas fa-calendar"></i> Calendar View
            </button>
            <button class="btn btn-secondary" id="listBtn" title="Toggle Calendar/List View">
                <i class="fas fa-list"></i> List View
            </button>
        </div>
    </div>
</div>

<!-- Calendar -->
<div id="calendarContainer">
    <div id="calendar"></div>
</div>

<!-- Bookings Table -->
<div id="tableContainer" style="display: none;">
    <div class="card">
        <div class="card-body">
            <div class="table-container">
                <table id="bookingsTable" class="table table-hover text-center align-middle" style="width:100%; white-space: nowrap;">
                    <thead style="text-align:center;">
                        <tr>
                            <th>Code</th>
                            <th>Title</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Duration</th>
                            <th>Room</th>
                            <th>User</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody style="text-align:center;"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Modals {
<!-- Add/Edit Booking Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-plus"></i>
                    <span id="modalTitle">Add New Booking</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bookingForm">
                    <input type="hidden" id="bookingId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">User</label>
                                <select class="form-control" id="bookingUserId" required>
                                    <option value="">Select User</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Room</label>
                                <select class="form-control" id="bookingRoomId" required>
                                    <option value="">Select Room</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="form-label">Meeting Title</label>
                                <input type="text" class="form-control" id="bookingTitle" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-control" id="bookingDate" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-label">Start Time</label>
                                <input type="time" class="form-control" id="bookingStartTime" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-label">End Time</label>
                                <input type="time" class="form-control" id="bookingEndTime" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="bookingDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveBookingBtn">
                    <i class="fas fa-save"></i> Save Booking
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-sync-alt"></i> Update Status
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="statusBookingId">
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-control" id="statusSelect">
                        <option value="Confirmed">Confirmed</option>
                        <option value="Pending">Pending</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="form-group" id="reasonGroup" style="display: none;">
                    <label class="form-label">Reason (for Cancelled)</label>
                    <textarea class="form-control" id="statusReason" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateStatusBtn">Update</button>
            </div>
        </div>
    </div>
</div>
}

@section Scripts {
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    
    <script>
        let bookingsTable, calendar, currentView = 'calendar';
        let users = [], rooms = [];

        $(document).ready(function() {
            initializeDataTable();
            loadUsers();
            loadRooms();
            loadBookings();
            bindEvents();
            initializeCalendar();
        });

        function initializeDataTable() {
            bookingsTable = $('#bookingsTable').DataTable({
                responsive: false,
                scrollX: true,
                pageLength: 25,
                order: [[2, 'desc'], [3, 'asc']],
                language: {
                    search: '',
                    searchPlaceholder: 'Search bookings...',
                    lengthMenu: 'Show _MENU_ bookings',
                    info: 'Showing _START_ to _END_ of _TOTAL_ bookings',
                    emptyTable: 'No bookings found',
                    paginate: { previous: '«', next: '»' }
                },
                dom: 'row<"mb-2 col-md-6"l><"col-md-6 text-end"f>rt<"row mt-2 col-md-6"i><"col-md-6"p>',
                columns: [
                    { data: 'booking_code', className: 'text-center' },
                    { data: 'booking_meeting_title', className: 'text-center' },
                    {
                        data: 'booking_date',
                        className: 'text-center',
                        render: data => new Date(data).toLocaleDateString()
                    },
                    {
                        data: null,
                        className: 'text-center',
                        render: d => `${d.booking_start_time} - ${d.booking_end_time}`
                    },
                    {
                        data: null,
                        className: 'text-center',
                        render: d => {
                            if (!d.booking_start_time || !d.booking_end_time) return '-';
                            return `${d.booking_duration_minutes ?? '-'} min`;
                        }
                    },
                    { data: 'room_name', className: 'text-center' },
                    { data: 'user_full_name', className: 'text-center' },
                    {
                        data: 'booking_status',
                        className: 'text-center',
                        render: status => {
                            const map = {
                                'Confirmed': 'status-confirmed',
                                'Pending': 'status-pending',
                                'In Progress': 'status-progress',
                                'Cancelled': 'status-cancelled'
                            };
                            return `<span class="booking-status-badge ${map[status]}">${status}</span>`;
                        }
                    },
                    {
                        data: null,
                        orderable: false,
                        render: d => `
                            <div style="display:flex;gap:6px;justify-content:center;">
                                <button class="btn-icon btn-edit"
                                        onclick="editBooking(${d.booking_id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-icon btn-warning"
                                        onclick="showStatusModal(${d.booking_id}, '${d.booking_status}')">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        `
                    }
                ]
            });
        }

        function bindEvents() {
            $('#searchInput, #statusFilter, #roomFilter').on('keyup change', loadBookings);
            
            $('#calendarBtn').click(() => switchView('calendar'));
            $('#listBtn').click(() => switchView('list'));
            
            $('#addBookingBtn').click(() => {
                $('#bookingForm')[0].reset();
                $('#modalTitle').text('Add New Booking');
                $('#bookingModal').modal('show');
            });
            
            $('#saveBookingBtn').click(saveBooking);
            $('#updateStatusBtn').click(updateStatus);
            
            $('#statusSelect').change(function() {
                $('#reasonGroup').toggle($(this).val() === 'Cancelled');
            });
            
            $('#exportBtn').click(exportBookings);
        }

        function switchView(view) {
            currentView = view;
            if (view === 'calendar') {
                $('#calendarContainer').show();
                $('#tableContainer').hide();
                $('#calendar').fullCalendar('refetchEvents');
            } else {
                $('#tableContainer').show();
                $('#calendarContainer').hide();
                loadBookings();
            }
        }

        function loadUsers() {
            $.ajax({
                url: '@Url.Action("GetUsers", "Admin")',
                method: 'GET',
                success: response => {
                    if (response.success) {
                        users = response.data;
                        const userSelect = $('#bookingUserId');
                        userSelect.empty().append('<option value="">Select User</option>');
                        users.forEach(user => {
                            userSelect.append(`<option value="${user.user_id}">${user.user_full_name} (${user.user_employee_id})</option>`);
                        });
                    }
                }
            });
        }

        function loadRooms() {
            $.ajax({
                url: '@Url.Action("GetRooms", "Admin")',
                method: 'GET',
                success: response => {
                    if (response.success) {
                        rooms = response.data;
                        const roomSelect = $('#bookingRoomId');
                        const roomFilter = $('#roomFilter');
                        roomSelect.empty().append('<option value="">Select Room</option>');
                        roomFilter.empty().append('<option value="">All Rooms</option>');
                        
                        rooms.forEach(room => {
                            const roomName = `${room.room_code} - ${room.room_name}`;
                            roomSelect.append(`<option value="${room.room_id}">${roomName}</option>`);
                            roomFilter.append(`<option value="${room.room_id}">${roomName}</option>`);
                        });
                    }
                }
            });
        }

        function loadBookings() {
            const search = $('#searchInput').val();
            const status = $('#statusFilter').val();
            const roomId = $('#roomFilter').val();

            $.ajax({
                url: '@Url.Action("GetBookings", "Admin")',
                method: 'GET',
                data: { search, status, roomId: roomId ? parseInt(roomId) : null },
                success: response => {
                    if (response.success) {
                        bookingsTable.clear().rows.add(response.data).draw();
                        updateStats(response.data);
                    }
                }
            });
        }

        function updateStats(bookings) {
            const now = new Date();

            const today = bookings.filter(b =>
                new Date(b.booking_date).toDateString() === now.toDateString()
            ).length;

            const active = bookings.filter(b => {
                if (b.booking_status !== 'Confirmed') return false;
                const start = new Date(`${b.booking_date} ${b.booking_start_time}`);
                const end   = new Date(`${b.booking_date} ${b.booking_end_time}`);
                return now >= start && now <= end;
            }).length;

            $('#totalBookings').text(bookings.length);
            $('#todayBookings').text(today);
            $('#activeBookings').text(active);
        }

        function saveBooking() {
            if (!$('#bookingForm')[0].checkValidity()) {
                $('#bookingForm')[0].reportValidity();
                return;
            }

            const bookingId = $('#bookingId').val();
            const bookingData = {
                booking_id: bookingId ? parseInt(bookingId) : 0,
                booking_user_id: parseInt($('#bookingUserId').val()),
                booking_room_id: parseInt($('#bookingRoomId').val()),
                booking_meeting_title: $('#bookingTitle').val(),
                booking_meeting_description: $('#bookingDescription').val(),
                booking_date: $('#bookingDate').val(),
                booking_start_time: $('#bookingStartTime').val(),
                booking_end_time: $('#bookingEndTime').val(),
                booking_status: 'Confirmed'
            };

            console.log(bookingData);

            const url = bookingId ? '@Url.Action("UpdateBooking", "Admin")' : '@Url.Action("CreateBooking", "Admin")';
            
            $.ajax({
                url,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(bookingData),
                success: response => {
                    if (response.success) {
                        Swal.fire('Success!', response.message, 'success');
                        $('#bookingModal').modal('hide');
                        if (currentView === 'list') loadBookings();
                        else calendar.refetchEvents();
                    } else {
                        Swal.fire('Error!', response.message, 'error');
                    }
                },
                error: () => Swal.fire('Error!', 'Failed to save booking', 'error')
            });
        }

        function editBooking(bookingId) {
            // Find booking data and populate form (simplified - would need to fetch from server)
            $('#modalTitle').text('Edit Booking');
            $('#bookingModal').modal('show');
        }

        function showStatusModal(bookingId, currentStatus) {
            $('#statusBookingId').val(bookingId);
            $('#statusSelect').val(currentStatus);
            $('#reasonGroup').hide();
            $('#statusModal').modal('show');
        }

        function updateStatus() {
            const bookingId = parseInt($('#statusBookingId').val());
            const status = $('#statusSelect').val();
            const reason = status === 'Cancelled' ? $('#statusReason').val() : null;

            $.ajax({
                url: '@Url.Action("UpdateBookingStatus", "Admin")',
                method: 'POST',
                data: { bookingId, status, reason },
                success: response => {
                    if (response.success) {
                        Swal.fire('Success!', response.message, 'success');
                        $('#statusModal').modal('hide');
                        if (currentView === 'list') loadBookings();
                        else calendar.refetchEvents();
                    } else {
                        Swal.fire('Error!', response.message, 'error');
                    }
                }
            });
        }

        function exportBookings() {
            const search = $('#searchInput').val();
            const status = $('#statusFilter').val();
            const roomId = $('#roomFilter').val();
            window.location.href = `@Url.Action("ExportBookings", "Admin")?search=${search}&status=${status}&roomId=${roomId}`;
        }

        function initializeCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: function(fetchInfo, successCallback, failureCallback) {
                    $.ajax({
                        url: '@Url.Action("GetCalendarBookings", "Admin")',
                        method: 'GET',
                        data: {
                            start: fetchInfo.startStr,
                            end: fetchInfo.endStr
                        },
                        success: response => {
                            if (response.success) {
                                successCallback(response.data);
                            }
                        }
                    });
                },
                eventClick: function(info) {
                    Swal.fire({
                        title: info.event.title,
                        html: `                            
                                <strong>Code:</strong> ${info.event.extendedProps.code}<br>
                                <strong>Room:</strong> ${info.event.extendedProps.room}<br>
                                <strong>User:</strong> ${info.event.extendedProps.user}<br>
                                <strong>Status:</strong> ${info.event.extendedProps.status}
                        `,
                        icon: 'info'
                    });
                },
                eventDidMount: function(info) {
                    info.el.style.cursor = 'pointer';
                }
            });
            calendar.render();
        }
    </script>
}
