@{
    ViewData["Title"] = "Users Management";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="users-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="header-content">
            <div class="header-left">
                <h1 class="page-title">
                    <i class="fas fa-users"></i>
                    Users Management
                </h1>
                <p class="page-subtitle">Manage system users, roles, and permissions</p>
            </div>
            <div class="header-right">
                <button class="btn btn-secondary" onclick="exportUsers()">
                    <i class="fas fa-file-excel"></i>
                    Export Excel
                </button>
                <button class="btn btn-primary" onclick="showAddUserModal()">
                    <i class="fas fa-user-plus"></i>
                    Add New User
                </button>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-card">
        <div class="filters-header">
            <h3><i class="fas fa-filter"></i> Filters</h3>
            <button class="btn-link" onclick="resetFilters()">
                <i class="fas fa-redo"></i> Reset
            </button>
        </div>
        <div class="filters-body">
            <div class="filter-group">
                <label>Search</label>
                <input type="text" class="form-control" id="searchInput" placeholder="Search by name, email, or employee ID...">
            </div>
            <div class="filter-group">
                <label>Role</label>
                <select class="form-select" id="roleFilter">
                    <option value="">All Roles</option>
                    <option value="Admin">Admin</option>
                    <option value="Employee">Employee</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Department</label>
                <select class="form-select" id="deptFilter">
                    <option value="">All Departments</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Status</label>
                <select class="form-select" id="statusFilter">
                    <option value="">All Status</option>
                    <option value="true">Active</option>
                    <option value="false">Inactive</option>
                </select>
            </div>
            <div class="filter-actions">
                <button class="btn btn-primary" onclick="applyFilters()">
                    <i class="fas fa-search"></i> Apply Filters
                </button>
            </div>
        </div>
    </div>

    <!-- Users Table -->
    <div class="table-card">
        <div class="table-responsive">
            <table id="usersTable" class="table table-hover">
                <thead>
                    <tr>
                        <th>Employee ID</th>
                        <th>Full Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Department</th>
                        <th>Status</th>
                        <th>Last Login</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add/Edit User Modal -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-edit"></i>
                    <span id="modalTitle">Add New User</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Employee ID *</label>
                            <input type="text" class="form-control" id="employeeId" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Full Name *</label>
                            <input type="text" class="form-control" id="fullName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="phone">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Role *</label>
                            <select class="form-select" id="role" required>
                                <option value="">Select Role</option>
                                <option value="Admin">Admin</option>
                                <option value="Employee">Employee</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Department *</label>
                            <select class="form-select" id="department" required>
                                <option value="">Select Department</option>
                            </select>
                            <button type="button" class="btn btn-sm btn-link" onclick="showAddDepartmentModal()">
                                <i class="fas fa-plus"></i> Add New Department
                            </button>
                        </div>
                        <div class="col-12 mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="isActive" checked>
                                <label class="form-check-label" for="isActive">Active Status</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveUser()">
                    <i class="fas fa-save"></i> Save User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Department Modal -->
<div class="modal fade" id="departmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-building"></i>
                    Add New Department
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="departmentForm">
                    <div class="mb-3">
                        <label class="form-label">Department Code *</label>
                        <input type="text" class="form-control" id="deptCode" required maxlength="10">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Department Name *</label>
                        <input type="text" class="form-control" id="deptName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="deptDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveDepartment()">
                    <i class="fas fa-save"></i> Save Department
                </button>
            </div>
        </div>
    </div>
</div>

@section Styles {
<style>
.filters-card {
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.filters-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--gray-100);
}

.filters-header h3 {
    margin: 0;
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--primary-dark);
}

.btn-link {
    background: none;
    border: none;
    color: var(--primary);
    cursor: pointer;
    font-weight: 600;
    padding: 0.25rem 0.5rem;
    transition: all 0.3s ease;
}

.btn-link:hover {
    color: var(--primary-dark);
}

.filters-body {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    align-items: end;
}

.filter-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: var(--gray-700);
    font-size: 0.875rem;
}

.filter-actions {
    display: flex;
    align-items: flex-end;
}

.table-card {
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.table {
    margin-bottom: 0;
}

.table thead th {
    background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
    color: white;
    font-weight: 600;
    border: none;
    padding: 1rem;
    white-space: nowrap;
}

.table tbody td {
    padding: 1rem;
    vertical-align: middle;
    border-bottom: 1px solid var(--gray-200);
}

.table tbody tr:hover {
    background: var(--gray-50);
}

.badge {
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.75rem;
}

.badge-success {
    background: rgba(40, 167, 69, 0.1);
    color: #28a745;
}

.badge-danger {
    background: rgba(220, 53, 69, 0.1);
    color: #dc3545;
}

.badge-primary {
    background: rgba(122, 162, 46, 0.1);
    color: var(--primary-dark);
}

.badge-secondary {
    background: rgba(108, 117, 125, 0.1);
    color: #6c757d;
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
}

.btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
}

.btn-icon {
    width: 32px;
    height: 32px;
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
}

.modal-content {
    border-radius: 16px;
    border: none;
}

.modal-header {
    background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
    color: white;
    border-radius: 16px 16px 0 0;
    border: none;
}

.modal-header .btn-close {
    filter: brightness(0) invert(1);
}

.form-label {
    font-weight: 600;
    color: var(--gray-700);
    margin-bottom: 0.5rem;
}

.form-control, .form-select {
    border: 2px solid var(--gray-300);
    border-radius: 8px;
    padding: 0.625rem 0.875rem;
    transition: all 0.3s ease;
}

.form-control:focus, .form-select:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(122, 162, 46, 0.1);
}
</style>
}

@section Scripts {
<script>
let usersTable;
let currentUserId = null;

$(document).ready(function() {
    initializeTable();
    loadDepartments();
    
    // Search with debounce
    let searchTimeout;
    $('#searchInput').on('keyup', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
            applyFilters();
        }, 500);
    });
});

function initializeTable() {
    usersTable = $('#usersTable').DataTable({
        processing: true,
        serverSide: false,
        ajax: {
            url: '/Admin/GetUsers',
            dataSrc: 'data'
        },
        columns: [
            { data: 'user_employee_id' },
            { data: 'user_full_name' },
            { data: 'user_email' },
            { 
                data: 'user_role',
                render: function(data) {
                    return `<span class="badge ${data === 'Admin' ? 'badge-primary' : 'badge-secondary'}">${data}</span>`;
                }
            },
            { data: 'dept_name' },
            {
                data: 'user_is_active',
                render: function(data) {
                    return data ? '<span class="badge badge-success">Active</span>' : '<span class="badge badge-danger">Inactive</span>';
                }
            },
            {
                data: 'user_last_login',
                render: function(data) {
                    return data ? new Date(data).toLocaleString() : 'Never';
                }
            },
            {
                data: null,
                orderable: false,
                render: function(row) {
                    return `
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary btn-icon" onclick="editUser(${row.user_id})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm ${row.user_is_active ? 'btn-warning' : 'btn-success'} btn-icon" 
                                onclick="toggleUserStatus(${row.user_id}, ${!row.user_is_active})" 
                                title="${row.user_is_active ? 'Deactivate' : 'Activate'}">
                                <i class="fas fa-${row.user_is_active ? 'ban' : 'check'}"></i>
                            </button>
                            <button class="btn btn-sm btn-info btn-icon" onclick="resetPassword(${row.user_id})" title="Reset Password">
                                <i class="fas fa-key"></i>
                            </button>
                        </div>
                    `;
                }
            }
        ],
        order: [[0, 'desc']],
        pageLength: 25,
        language: {
            emptyTable: "No users found",
            loadingRecords: "Loading users..."
        }
    });
}

function loadDepartments() {
    $.get('/Admin/GetDepartments', function(response) {
        if (response.success) {
            const deptSelect = $('#department');
            const deptFilter = $('#deptFilter');
            
            deptSelect.empty().append('<option value="">Select Department</option>');
            deptFilter.append('<option value="">All Departments</option>');
            
            response.data.forEach(function(dept) {
                deptSelect.append(`<option value="${dept.dept_id}">${dept.dept_name}</option>`);
                deptFilter.append(`<option value="${dept.dept_id}">${dept.dept_name}</option>`);
            });
        }
    });
}

function showAddUserModal() {
    currentUserId = null;
    $('#modalTitle').text('Add New User');
    $('#userForm')[0].reset();
    $('#userId').val('');
    $('#isActive').prop('checked', true);
    $('#userModal').modal('show');
}

function editUser(userId) {
    currentUserId = userId;
    $('#modalTitle').text('Edit User');
    
    const rowData = usersTable.rows().data().toArray().find(u => u.user_id === userId);
    
    $('#userId').val(rowData.user_id);
    $('#employeeId').val(rowData.user_employee_id).prop('readonly', true);
    $('#email').val(rowData.user_email);
    $('#fullName').val(rowData.user_full_name);
    $('#phone').val(rowData.user_phone);
    $('#role').val(rowData.user_role);
    $('#department').val(rowData.user_dept_id);
    $('#isActive').prop('checked', rowData.user_is_active);
    
    $('#userModal').modal('show');
}

function saveUser() {
    const userId = $('#userId').val();
    const userData = {
        user_id: userId ? parseInt(userId) : 0,
        user_employee_id: $('#employeeId').val(),
        user_email: $('#email').val(),
        user_full_name: $('#fullName').val(),
        user_phone: $('#phone').val() || null,
        user_role: $('#role').val(),
        user_dept_id: parseInt($('#department').val()),
        user_is_active: $('#isActive').prop('checked')
    };
    
    const url = userId ? '/Admin/UpdateUser' : '/Admin/CreateUser';
    
    $.ajax({
        url: url,
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(userData),
        success: function(response) {
            if (response.success) {
                Swal.fire('Success!', response.message, 'success');
                $('#userModal').modal('hide');
                usersTable.ajax.reload();
            } else {
                Swal.fire('Error!', response.message, 'error');
            }
        },
        error: function() {
            Swal.fire('Error!', 'Failed to save user', 'error');
        }
    });
}

function toggleUserStatus(userId, newStatus) {
    Swal.fire({
        title: 'Confirm Action',
        text: `Are you sure you want to ${newStatus ? 'activate' : 'deactivate'} this user?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#7aa22e',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, proceed'
    }).then((result) => {
        if (result.isConfirmed) {
            $.post('/Admin/ToggleUserStatus', { userId: userId, isActive: newStatus }, function(response) {
                if (response.success) {
                    Swal.fire('Success!', response.message, 'success');
                    usersTable.ajax.reload();
                } else {
                    Swal.fire('Error!', response.message, 'error');
                }
            });
        }
    });
}

function resetPassword(userId) {
    Swal.fire({
        title: 'Reset Password',
        text: 'This will reset the password to the default (Password123)',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#7aa22e',
        confirmButtonText: 'Reset Password'
    }).then((result) => {
        if (result.isConfirmed) {
            $.post('/Admin/ResetUserPassword', { userId: userId }, function(response) {
                if (response.success) {
                    Swal.fire('Success!', response.message, 'success');
                } else {
                    Swal.fire('Error!', response.message, 'error');
                }
            });
        }
    });
}

function showAddDepartmentModal() {
    $('#departmentForm')[0].reset();
    $('#departmentModal').modal('show');
}

function saveDepartment() {
    const deptData = {
        dept_code: $('#deptCode').val(),
        dept_name: $('#deptName').val(),
        dept_description: $('#deptDescription').val() || null
    };
    
    $.ajax({
        url: '/Admin/CreateDepartment',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(deptData),
        success: function(response) {
            if (response.success) {
                Swal.fire('Success!', response.message, 'success');
                $('#departmentModal').modal('hide');
                loadDepartments();
            } else {
                Swal.fire('Error!', response.message, 'error');
            }
        }
    });
}

function applyFilters() {
    const search = $('#searchInput').val();
    const role = $('#roleFilter').val();
    const deptId = $('#deptFilter').val();
    const isActive = $('#statusFilter').val();
    
    usersTable.ajax.url('/Admin/GetUsers?' + $.param({
        search: search,
        role: role,
        deptId: deptId,
        isActive: isActive
    })).load();
}

function resetFilters() {
    $('#searchInput').val('');
    $('#roleFilter').val('');
    $('#deptFilter').val('');
    $('#statusFilter').val('');
    applyFilters();
}

function exportUsers() {
    const search = $('#searchInput').val();
    const role = $('#roleFilter').val();
    const deptId = $('#deptFilter').val();
    const isActive = $('#statusFilter').val();
    
    window.location.href = '/Admin/ExportUsers?' + $.param({
        search: search,
        role: role,
        deptId: deptId,
        isActive: isActive
    });
}
</script>
}